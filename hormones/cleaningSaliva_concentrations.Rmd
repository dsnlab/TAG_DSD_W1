---
title: "cleaning Saliva hormones"
author: "Nandi"
date: "9 May 2018"
output: html_document
---

```{r, include=FALSE}
#LOAD PACKAGES AND SET DIRECTORIES

packages <- c("Amelia", "lme4" , "merTools", "ggplot2","tidyr","stringr","knitr","corrplot","data.table","readxl","gridExtra","dplyr", "psych","kableExtra","lavaan","xlsx","jomo","mice","Hmisc")
if (length(setdiff(packages, rownames(installed.packages()))) > 0) {
  install.packages(setdiff(packages, rownames(installed.packages())))  
}
lapply(packages, library, character.only = TRUE)

options(digits=10)

cas_dir <- '/Volumes/psych-cog/dsnlab/TAG/'
saliva_dir <- paste0(cas_dir,'behavior/Saliva/Wave1')
```

###IMPORT TAG OVERVIEW DOC FROM CAS
```{r, include = F}
overview <- read.xlsx(paste0(cas_dir,'behavior/Overview/Overview_Withdrawn_Completed/TAG_Overview_Doc.xlsx'),1)
overview <- overview[,c("TAG_ID","W1S2_Completed","Withdrawn_W1","Exclusionary_Withdrawl")]

#removing everyone who withdrew at W1 (exclusionary withdrawals)
overview <- overview %>% 
  rename(SID = TAG_ID) %>%
  replace_na(list(Withdrawn_W1 = 0)) %>%
  replace_na(list(Exclusionary_Withdrawl = 0)) %>% 
  arrange(Exclusionary_Withdrawl) %>% 
  mutate(SID=gsub("[^0-9\\.]", "", SID)) %>%
  filter(Exclusionary_Withdrawl==0)
```

###IMPORT "FINAL" SALIVA CONCENTRATIONS
```{r, echo=FALSE, message=FALSE, warning=FALSE, results="asis", fig.height=4, fig.width=4}
###IMPORT & CLEAN CONCENTRATIONS 
#import dataframe for each hormone, create SID as 3 digit numeric factor (i.e. "001"), combine all three hormones in one dataframe. 
Sal_DHEA <- read_xlsx(paste0(saliva_dir,'/TAG_SALIVA_Master_File.xlsx'), sheet=4)
Sal_TEST <- read_xlsx(paste0(saliva_dir,'/TAG_SALIVA_Master_File.xlsx'), sheet=8)
Sal_EST <- read_xlsx(paste0(saliva_dir,'/TAG_SALIVA_Master_File.xlsx'), sheet=12)

Sal_DHEA <- Sal_DHEA %>% 
  mutate(Concentration = ifelse(Concentration =='?????',1,Concentration)) %>%
  mutate(SID = as.factor(round(as.numeric(ID),2)),
         sal_DHEA = round(as.numeric(Concentration),3)) %>%
  select(SID,sal_DHEA) %>%
  replace_na(list(sal_DHEA = "missing")) %>%
  filter(!is.na(SID)) %>%
  separate(SID, into =c("SID","week")) %>%
  mutate(SID = str_pad(SID, 3, pad = "0")) %>%
  mutate(SID = as.factor(SID),
         week = as.factor(week))

Sal_TEST <- Sal_TEST %>% 
  mutate(Concentration = ifelse(Concentration =='?????',4,Concentration)) %>%
  mutate(SID = as.factor(round(as.numeric(ID),2)),
         sal_TEST = round(as.numeric(Concentration),3)) %>%
  select(SID,sal_TEST) %>%
  replace_na(list(sal_TEST = "missing")) %>%
  filter(!is.na(SID)) %>%
  separate(SID, into =c("SID","week")) %>%
  mutate(SID = str_pad(SID, 3, pad = "0")) %>%
  mutate(SID = as.factor(SID),
         week = as.factor(week))

Sal_EST <- Sal_EST %>% 
  mutate(Concentration = ifelse(Concentration =='?????',0.1,Concentration)) %>%
  mutate(SID = as.factor(round(as.numeric(ID),2)),
         sal_EST = round(as.numeric(Concentration),3)) %>%
  select(SID,sal_EST) %>%
  replace_na(list(sal_EST = "missing")) %>%
  filter(!is.na(SID)) %>%
  separate(SID, into =c("SID","week")) %>%
  mutate(SID = str_pad(SID, 3, pad = "0")) %>%
  mutate(SID = as.factor(SID),
         week = as.factor(week))

Saliva <- Sal_DHEA %>% full_join(.,Sal_TEST) %>% full_join(.,Sal_EST) %>%
  mutate(ID = paste(SID,week,sep="_")) %>%
  filter(SID %in% overview$SID)
```

###IMPORT SALIVA CVs
```{r, echo=FALSE, message=FALSE, warning=FALSE, results="asis", fig.height=4, fig.width=4}
Sal_DHEA_CV <- read_xlsx(paste0(saliva_dir,'/TAG_SALIVA_Master_File.xlsx'), sheet=1)
Sal_TEST_CV <- read_xlsx(paste0(saliva_dir,'/TAG_SALIVA_Master_File.xlsx'), sheet=5)
Sal_EST_CV <- read_xlsx(paste0(saliva_dir,'/TAG_SALIVA_Master_File.xlsx'), sheet=9)

Sal_DHEA_CV <- Sal_DHEA_CV %>% 
  filter(!is.na(Name)) %>%
  select(Name,`CV (%)`, `CV (%)__1`) %>%
  rename(ID = Name,
         DHEA_CV = `CV (%)`,
         DHEA_450CV = `CV (%)__1`) %>%
  mutate(SID = as.factor(round(as.numeric(ID),2)),
         DHEA_CV = round(as.numeric(DHEA_CV),3),
         DHEA_450CV = round(as.numeric(DHEA_450CV),3)) %>%
  select(SID,DHEA_CV,DHEA_450CV) %>%
  separate(SID, into =c("SID","week")) %>%
  mutate(SID = str_pad(SID, 3, pad = "0")) %>%
  mutate(SID = as.factor(SID),
         week = as.factor(week)) %>%
  filter(!is.na(SID))

Sal_TEST_CV <- Sal_TEST_CV %>% 
  filter(!is.na(Name)) %>%
  select(Name,`CV (%)`, `CV (%)__1`) %>%
  rename(ID = Name,
         TEST_CV = `CV (%)`,
         TEST_450CV = `CV (%)__1`) %>%
  mutate(SID = as.factor(round(as.numeric(ID),2)),
         TEST_CV = round(as.numeric(TEST_CV),3),
         TEST_450CV = round(as.numeric(TEST_450CV),3)) %>%
  select(SID,TEST_CV,TEST_450CV) %>%
  separate(SID, into =c("SID","week")) %>%
  mutate(SID = str_pad(SID, 3, pad = "0")) %>%
  mutate(SID = as.factor(SID),
         week = as.factor(week)) %>%
  filter(!is.na(SID))

Sal_EST_CV <- Sal_EST_CV %>% 
  filter(!is.na(Name)) %>%
  select(Name,`CV (%)`, `CV (%)__1`) %>%
  rename(ID = Name,
         EST_CV = `CV (%)`,
         EST_450CV = `CV (%)__1`) %>%
  mutate(SID = as.factor(round(as.numeric(ID),2)),
         EST_CV = round(as.numeric(EST_CV),3),
         EST_450CV = round(as.numeric(EST_450CV),3)) %>%
  select(SID,EST_CV,EST_450CV) %>%
  separate(SID, into =c("SID","week")) %>%
  mutate(SID = str_pad(SID, 3, pad = "0")) %>%
  mutate(SID = as.factor(SID),
         week = as.factor(week)) %>%
  filter(!is.na(SID))

Saliva_CV <- Sal_DHEA_CV %>% full_join(.,Sal_TEST_CV) %>% full_join(.,Sal_EST_CV) %>%
  mutate(ID = paste(SID,week,sep="_")) %>%
  filter(SID %in% overview$SID)
```

###IMPORT SALIVA REPLICATES
```{r, echo=FALSE, message=FALSE, warning=FALSE, results="asis", fig.height=4, fig.width=4}

Sal_DHEA_CV_rep <- read_xlsx(paste0(saliva_dir,'/TAG_SALIVA_Master_File.xlsx'), sheet=3)
Sal_TEST_CV_rep <- read_xlsx(paste0(saliva_dir,'/TAG_SALIVA_Master_File.xlsx'), sheet=7)
Sal_EST_CV_rep <- read_xlsx(paste0(saliva_dir,'/TAG_SALIVA_Master_File.xlsx'), sheet=11)

Sal_DHEA_CV_rep <- Sal_DHEA_CV_rep %>%
  rename(SID = Name,
         rep1 = TAG_2017.07.18_DHEA_Yoojin.xlsx,
         rep2 = X__1,
         CV2 = X__2,
         notes = X__3) %>%
  mutate(rep1 = as.numeric(rep1)) %>%
  filter(!is.na(rep1)) %>%
  mutate(SID = as.factor(round(as.numeric(SID),2))) %>%
  separate(SID, into =c("SID","week")) %>%
  mutate(SID = str_pad(SID, 3, pad = "0")) %>%
  mutate(SID = as.factor(SID),
         week = as.factor(week)) %>%
  filter(!(SID == "Name")) %>%
  filter(SID %in% overview$SID)

Sal_TEST_CV_rep <- Sal_TEST_CV_rep %>% 
  rename(SID = Name,
         rep1 = tag_06.18.2017_testo_tray2_ellen.xlsx,
         rep2 = X__1,
         CV2 = X__2,
         notes = X__3) %>%
  mutate(rep1 = as.numeric(rep1)) %>%
  filter(!is.na(rep1)) %>%
  mutate(SID = as.factor(round(as.numeric(SID),2))) %>%
  separate(SID, into =c("SID","week")) %>%
  mutate(SID = str_pad(SID, 3, pad = "0")) %>%
  mutate(SID = as.factor(SID),
         week = as.factor(week)) %>%
  filter(!(SID == "Name"))  %>%
  filter(SID %in% overview$SID)

Sal_EST_CV_rep <- Sal_EST_CV_rep %>% 
  rename(SID = Name,
         rep1 = TAG_06.18.2017_Estradiol_Tray2_Olivia.xlsx,
         rep2 = X__1,
         CV2 = X__2,
         notes = X__3) %>%
  mutate(rep1 = as.numeric(rep1)) %>%
  filter(!is.na(rep1)) %>%
  mutate(SID = as.factor(round(as.numeric(SID),2))) %>%
  separate(SID, into =c("SID","week")) %>%
  mutate(SID = str_pad(SID, 3, pad = "0")) %>%
  mutate(SID = as.factor(SID),
         week = as.factor(week)) %>%
  filter(!(SID == "Name"))  %>%
  filter(SID %in% overview$SID)
```

###DISTRIBUTIONS OF CONCENTRATIONS
```{r, echo=FALSE, message=FALSE, warning=FALSE, results="asis", fig.height=7, fig.width=15}
Saliva_long <- gather(Saliva, hormone, concentration, c(sal_DHEA,sal_TEST,sal_EST), factor_key=TRUE)

#Saliva_long <- Saliva_long %>% 
#  mutate(missing = if_else(concentration == "missing",1,0))

Saliva_long <- Saliva_long %>%
  mutate(concentration = as.numeric(concentration))

Saliva_plot <- Saliva_long %>% 
  ggplot(aes(x = concentration)) +
  geom_histogram(color="black",fill="white") +
  facet_wrap(~ hormone, scales="free")

Saliva_plot

#hist(subset(Saliva_long, hormone == "sal_DHEA")$concentration, main="", xlab="DHEA")
#abline(v=600,col="red")
#writeLines("\n")
#hist(subset(Saliva_long, hormone == "sal_TEST")$concentration, main="", xlab="TEST")
#abline(v=200,col="red")
#writeLines("\n")
#hist(subset(Saliva_long, hormone == "sal_EST")$concentration, main="", xlab="EST")
#abline(v=3,col="red")
#writeLines("\n")
```

###DISTRIBUTIONS OF ICV
```{r, echo=FALSE, message=FALSE, warning=FALSE, results="asis", fig.height=7, fig.width=15}
CVplot <- Saliva_CV %>% select(SID, DHEA_CV, TEST_CV, EST_CV) %>%
  gather(-SID, key = "var", value = "value") %>% 
  ggplot(aes(x = value)) +
  geom_histogram(color="black",fill="white") +
  facet_wrap(~ var,scales="free")

CVplot

#if we want to see how many kids have CV > 30...
DHEA_CV_exc <- Saliva_CV %>% filter(DHEA_CV > 30) %>% select(ID)
TEST_CV_exc <- Saliva_CV %>% filter(TEST_CV > 30) %>% select(ID)
EST_CV_exc <- Saliva_CV %>% filter(EST_CV > 30) %>% select(ID)
```

```{r, include=FALSE}
###INDIVIDUAL ICV PLOTS - DO NOT PRINT
DHEA_CV<-ggplot(Saliva_CV, aes(x=DHEA_CV)) +
  geom_histogram(color="black",fill="white")
# + geom_vline(xintercept=30,linetype="dashed",colour="red")
DHEA_CV

TEST_CV<-ggplot(Saliva_CV, aes(x=TEST_CV)) +
  geom_histogram(color="black",fill="white")
# + geom_vline(xintercept=30,linetype="dashed",colour="red")
TEST_CV

EST_CV<-ggplot(Saliva_CV, aes(x=EST_CV)) +
  geom_histogram(color="black",fill="white")
# + geom_vline(xintercept=30,linetype="dashed",colour="red")
EST_CV
```

###DISTRIBUTIONS OF 450 ICV
```{r, echo=FALSE, message=FALSE, warning=FALSE, results="asis", fig.height=7, fig.width=15}

CV_450_plot <- Saliva_CV %>% select(SID, DHEA_450CV, TEST_450CV, EST_450CV) %>%
  gather(-SID, key = "var", value = "value") %>% 
  ggplot(aes(x = value)) +
  geom_histogram(color="black",fill="white") +
  facet_wrap(~ var,scales="free")

CV_450_plot

#if we want to see how many kids have CV > 30...
DHEA_450CV_exc <- Saliva_CV %>% filter(DHEA_450CV > 20) %>% select(ID)
TEST_450CV_exc <- Saliva_CV %>% filter(TEST_450CV > 20) %>% select(ID)
EST_450CV_exc <- Saliva_CV %>% filter(EST_450CV > 20) %>% select(ID)
```

###THE REST OF THE SCRIPT EXAMINES HOW TO BEST CONTROL FOR EXTRANEOUS FACTORS AND CREATE A MEAN (BASAL) SALIVA CONCENTRATION

###CHECK ASSOCIATIONS WITH CONTROL VARIABLES
```{r, echo=FALSE, message=FALSE, warning=FALSE, results="asis", fig.height=7, fig.width=15}

control_df <- read.csv(paste0(saliva_dir,'/W1_at_home_saliva_overview.csv'))
control_df <- control_df %>% 
  mutate(SID=gsub("[^0-9\\.]", "", subject_spit_id)) %>%
  mutate(SID = as.factor(SID)) %>%
  select(SID, s1_complete, s1_doc, s1_wake_up_time, s1_start_time, s1_time_to_collect, s1_medicines_y_n, s1_sick_y_n, s2_complete, s2_doc, s2_wake_up_time, s2_start_time, s2_time_to_collect, s2_medicines_y_n, s2_sick_y_n, s3_complete, s3_doc, s3_wake_up_time, s3_start_time, s3_time_to_collect, s3_medicines_y_n, s3_sick_y_n, s4_complete, s4_doc, s4_wake_up_time, s4_start_time, s4_time_to_collect, s4_medicines_y_n, s4_sick_y_n, s5_complete, s5_doc, s5_wake_up_time, s5_start_time, s5_time_to_collect, s5_medicines_y_n, s5_sick_y_n, s6_complete, s6_doc, s6_wake_up_time, s6_start_time, s6_time_to_collect, s6_medicines_y_n, s6_sick_y_n, s7_complete, s7_doc, s7_start_time, s7_time_to_collect, s7_medicines_y_n, s7_sick_y_n, s8_complete, s8_doc, s8_time_to_collect, s8_medicines_y_n, s8_sick_y_n) %>% ##need to add in s7_wake_up_time and s8_wake_up_time
  filter(!SID=="") 

control_long <- gather(control_df, weeks, measurement, -SID) %>%
  separate(weeks, c("week", "variable"), extra = "merge") %>%
  spread(variable,measurement) %>%
  mutate(week=gsub("[^0-9\\.]", "", week))

#combine Saliva and Control variables
Saliva_control_long <- Saliva_long %>% left_join(., control_long) 

#make blank cells NAs:
Saliva_control_long <- apply(Saliva_control_long, 2, function(x) gsub("^$|^ $", NA, x))

#make variables into appropriate factors
Saliva_control_long <- as.data.frame(Saliva_control_long) %>%
  mutate(sick_y_n = as.factor(sick_y_n),
         medicines_y_n = as.factor(medicines_y_n),
         start_time=as.POSIXct(start_time,format="%H:%M"),
         wake_up_time=as.POSIXct(wake_up_time,format="%H:%M"),
         time_to_collect=as.numeric(as.character(time_to_collect)),
         concentration=as.numeric(as.character(concentration)))

Saliva_control_long2 <- Saliva_control_long %>%
  mutate(start_time = as.numeric(start_time)) %>%
  mutate(start_time = start_time - 1528190000) %>%
  mutate(wake_up_time = as.numeric(wake_up_time)) %>%
  mutate(wake_up_time = wake_up_time - 1528190000)

#check effect of control variables using LMER (long dataset)
DHEA <- Saliva_control_long2 %>% filter(hormone=="sal_DHEA") %>%
  filter(complete.cases(concentration,start_time,sick_y_n,medicines_y_n,wake_up_time,time_to_collect))                 
                                       
DHEA_null <- lmer(concentration ~ 1 + (1 | SID), data=DHEA, REML = F)
DHEA_start_time <- lmer(concentration ~ start_time + (1 | SID), data=DHEA, REML = F)
DHEA_wake_up_time <- lmer(concentration ~ wake_up_time + (1 | SID), data=DHEA, REML = F)
DHEA_time_to_collect <- lmer(concentration ~ time_to_collect + (1 | SID), data=DHEA, REML = F)
DHEA_sick_y_n <- lmer(concentration ~ sick_y_n + (1 | SID), data=DHEA, REML = F)
DHEA_medicines_y_n <- lmer(concentration ~ medicines_y_n + (1 | SID), data=DHEA, REML = F)
anova(DHEA_null,DHEA_start_time)
anova(DHEA_null,DHEA_wake_up_time)
anova(DHEA_null,DHEA_time_to_collect)
anova(DHEA_null,DHEA_sick_y_n)
anova(DHEA_null,DHEA_medicines_y_n)

TEST <- Saliva_control_long2 %>% filter(hormone=="sal_TEST") %>%
  filter(complete.cases(concentration,start_time,sick_y_n,medicines_y_n,wake_up_time,time_to_collect))                 
                                       
TEST_null <- lmer(concentration ~ 1 + (1 | SID), data=TEST, REML = F)
TEST_start_time <- lmer(concentration ~ start_time + (1 | SID), data=TEST, REML = F)
TEST_wake_up_time <- lmer(concentration ~ wake_up_time + (1 | SID), data=TEST, REML = F)
TEST_time_to_collect <- lmer(concentration ~ time_to_collect + (1 | SID), data=TEST, REML = F)
TEST_sick_y_n <- lmer(concentration ~ sick_y_n + (1 | SID), data=TEST, REML = F)
TEST_medicines_y_n <- lmer(concentration ~ medicines_y_n + (1 | SID), data=TEST, REML = F)
anova(TEST_null,TEST_start_time) #trending
anova(TEST_null,TEST_wake_up_time)
anova(TEST_null,TEST_time_to_collect)
anova(TEST_null,TEST_sick_y_n)
anova(TEST_null,TEST_medicines_y_n)

EST <- Saliva_control_long2 %>% filter(hormone=="sal_EST") %>%
  filter(complete.cases(concentration,start_time,sick_y_n,medicines_y_n,wake_up_time,time_to_collect))                 
                                       
EST_null <- lmer(concentration ~ 1 + (1 | SID), data=EST, REML = F)
EST_start_time <- lmer(concentration ~ start_time + (1 | SID), data=EST, REML = F)
EST_wake_up_time <- lmer(concentration ~ wake_up_time + (1 | SID), data=EST, REML = F)
EST_time_to_collect <- lmer(concentration ~ time_to_collect + (1 | SID), data=EST, REML = F)
EST_sick_y_n <- lmer(concentration ~ sick_y_n + (1 | SID), data=EST, REML = F)
EST_medicines_y_n <- lmer(concentration ~ medicines_y_n + (1 | SID), data=EST, REML = F)
anova(EST_null,EST_start_time)
anova(EST_null,EST_wake_up_time)
anova(EST_null,EST_time_to_collect)
anova(EST_null,EST_sick_y_n)
anova(EST_null,EST_medicines_y_n) #sig

#Now checking effect of control variables using LM (not accounting for ID grouping)
summary(lm(concentration ~ start_time, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_DHEA")))
summary(lm(concentration ~ start_time, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_TEST")))
summary(lm(concentration ~ start_time, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_EST"))) #sig effect

summary(lm(concentration ~ wake_up_time, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_DHEA"))) #trending
summary(lm(concentration ~ wake_up_time, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_TEST")))
summary(lm(concentration ~ wake_up_time, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_EST")))

summary(lm(concentration ~ sick_y_n, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_DHEA")))
summary(lm(concentration ~ sick_y_n, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_TEST")))
summary(lm(concentration ~ sick_y_n, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_EST")))

summary(lm(concentration ~ medicines_y_n, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_DHEA")))
summary(lm(concentration ~ medicines_y_n, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_TEST")))
summary(lm(concentration ~ medicines_y_n, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_EST"))) #sig effect
                   
summary(lm(concentration ~ time_to_collect, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_DHEA")))
summary(lm(concentration ~ time_to_collect, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_TEST")))
summary(lm(concentration ~ time_to_collect, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_EST")))

#plot start_time distribution
Start_time <- Saliva_control_long %>% filter(hormone=="sal_EST") %>% select(SID,week,start_time) %>% arrange(start_time)
Start_time <- as.POSIXlt(Start_time$start_time)$hour
hist(Start_time, breaks=seq(0, 23), main="Start time (hour)")

#consistencies across LM and LMER = EST * medicines.
```

###CALCULATE RESIDUALS WITH LMER
```{r}
#Testing out extraction of random effects using merTools after multiple imputation with Amelia 
ranef.merModList <- function(object, ...){
levels <- getME(object[[1]], "n_rfacs")
re <- vector(length = levels, mode = "list")
for(i in seq_along(1:levels)){
# <- Reduce(`+`, lapply(object, ranef)[i]) / length(object)
re[i]  <- lapply(Reduce(`+`, lapply(object, ranef)[1]), function(x) x/length(object))
}
names(re) <- names(ranef(object[[1]]))
return(re)
}

#testing on DHEA:
DHEA <- Saliva_control_long %>% filter(hormone=="sal_DHEA") %>% 
  mutate(SID=as.factor(SID),
         week=as.numeric(week)) %>%
  select(SID,week,concentration,medicines_y_n,sick_y_n,time_to_collect,start_time,wake_up_time) %>%
  mutate(timediff = difftime(start_time,wake_up_time)/60) %>%
  mutate(timediff = as.numeric(timediff)) %>%
  mutate(start_time = as.numeric(start_time)) %>%
  mutate(start_time = start_time - 1528190000) %>%
  #mutate(start_time = start_time/10000000) %>%
  select(-wake_up_time)

#imputation with Amelia
aout <- amelia(DHEA, idvars = "SID", 
            ords = c("medicines_y_n","sick_y_n"),
            ts="week",
            m = 5)

aout_list <- as.list(aout$imputations) 

fml <- "concentration ~ start_time + medicines_y_n + sick_y_n + time_to_collect + timediff + (1 | SID)"
mod <- lmerModList(fml, data = aout_list)

DHEA_ranef <- as.data.frame(ranef.merModList(mod))
DHEA_ranef <- DHEA_ranef %>% add_rownames(., var="SID") %>%
  rename(raneff = X.Intercept.)

#testing on TEST:
TEST <- Saliva_control_long %>% filter(hormone=="sal_TEST") %>% 
  mutate(SID=as.factor(SID),
         week=as.numeric(week)) %>%
  select(SID,week,concentration,medicines_y_n,sick_y_n,time_to_collect,start_time,wake_up_time) %>%
  mutate(timediff = difftime(start_time,wake_up_time)/60) %>%
  mutate(timediff = as.numeric(timediff)) %>%
  mutate(start_time = as.numeric(start_time)) %>%
  mutate(start_time = start_time - 1528190000) %>%
  #mutate(start_time = start_time/10000000) %>%
  select(-wake_up_time)

#imputation with Amelia
aout <- amelia(TEST, idvars = "SID", 
            ords = c("medicines_y_n","sick_y_n"),
            ts="week",
            m = 5)

aout_list <- as.list(aout$imputations) 

fml <- "concentration ~ start_time + medicines_y_n + sick_y_n + time_to_collect + timediff + (1 | SID)"
mod <- lmerModList(fml, data = aout_list)

TEST_ranef <- as.data.frame(ranef.merModList(mod))
TEST_ranef <- TEST_ranef %>% add_rownames(., var="SID") %>%
  rename(raneff = X.Intercept.)

#testing on EST:
EST <- Saliva_control_long %>% filter(hormone=="sal_EST") %>% 
  mutate(SID=as.factor(SID),
         week=as.numeric(week)) %>%
  select(SID,week,concentration,medicines_y_n,sick_y_n,time_to_collect,start_time,wake_up_time) %>%
  mutate(timediff = difftime(start_time,wake_up_time)/60) %>%
  mutate(timediff = as.numeric(timediff)) %>%
  mutate(start_time = as.numeric(start_time)) %>%
  mutate(start_time = start_time - 1528190000) %>%
  select(-wake_up_time)

#imputation with Amelia
aout <- amelia(EST, idvars = "SID", 
            ords = c("medicines_y_n","sick_y_n"),
            ts="week",
            m = 5)

aout_list <- as.list(aout$imputations) 

fml <- "concentration ~ start_time + medicines_y_n + sick_y_n + time_to_collect + timediff + (1 | SID)"
mod <- lmerModList(fml, data = aout_list)

EST_ranef <- as.data.frame(ranef.merModList(mod))
EST_ranef <- EST_ranef %>% add_rownames(., var="SID") %>%
  rename(raneff = X.Intercept.)
```

###CALCULATE RESIDUALS FOR CROSS-SEC DATAFRAME AND THEN AVERAGE
```{r}
#using MICE to impute and run pooled analyses

#DHEA
impDHEA <- mice(DHEA,m=5,maxit=50,meth='pmm',seed=500)

modelFit1 <- with(impDHEA,lm(concentration~ start_time + medicines_y_n + sick_y_n + time_to_collect + timediff))
summary(pool(modelFit1))

#extract residuals for each imputation
DHEA$resid1 <- modelFit1$analyses[[1]]$residuals
DHEA$resid2 <- modelFit1$analyses[[2]]$residuals
DHEA$resid3 <- modelFit1$analyses[[3]]$residuals
DHEA$resid4 <- modelFit1$analyses[[4]]$residuals
DHEA$resid5 <- modelFit1$analyses[[5]]$residuals

DHEA <- DHEA %>%
  rowwise %>%
  mutate(resid = mean(c(resid1,resid2,resid3,resid4,resid5)))

#calculate mean residual, as well as mean of original concentrations 
DHEA_mean <- DHEA %>% ungroup() %>%
  mutate(x="x") %>%
  group_by(SID) %>%
  summarise(residMean = mean(resid),
            Mean = mean(concentration,na.rm=T)) %>%
  left_join(.,DHEA_ranef)

#plot mean vs. residMean vs. raneff - SEEMS LIKE EITHER RESID OR RANEFF ARE GOOD OPTIONS - ALL CORS ABOVE 0.99
pairs(~residMean+Mean+raneff,data=DHEA_mean, 
   main="Simple Scatterplot Matrix")

#TEST
impTEST <- mice(TEST,m=5,maxit=50,meth='pmm',seed=500)

modelFit1 <- with(impTEST,lm(concentration~ start_time + medicines_y_n + sick_y_n + time_to_collect + timediff))
summary(pool(modelFit1))

#extract residuals for each imputation
TEST$resid1 <- modelFit1$analyses[[1]]$residuals
TEST$resid2 <- modelFit1$analyses[[2]]$residuals
TEST$resid3 <- modelFit1$analyses[[3]]$residuals
TEST$resid4 <- modelFit1$analyses[[4]]$residuals
TEST$resid5 <- modelFit1$analyses[[5]]$residuals

TEST <- TEST %>%
  rowwise %>%
  mutate(resid = mean(c(resid1,resid2,resid3,resid4,resid5)))

#calculate mean residual, as well as mean of original concentrations 
TEST_mean <- TEST %>% ungroup() %>%
  mutate(x="x") %>%
  group_by(SID) %>%
  summarise(residMean = mean(resid),
            Mean = mean(concentration,na.rm=T)) %>%
  left_join(.,TEST_ranef)

#plot mean vs. residMean vs. raneff - SEEMS LIKE EITHER RESID OR RANEFF ARE GOOD OPTIONS - ALL CORS ABOVE 0.99
pairs(~residMean+Mean+raneff,data=TEST_mean, 
   main="Simple Scatterplot Matrix") 

#EST
impEST <- mice(EST,m=5,maxit=50,meth='pmm',seed=500)

modelFit1 <- with(impEST,lm(concentration~ start_time + medicines_y_n + sick_y_n + time_to_collect + timediff))
summary(pool(modelFit1))

#extract residuals for each imputation
EST$resid1 <- modelFit1$analyses[[1]]$residuals
EST$resid2 <- modelFit1$analyses[[2]]$residuals
EST$resid3 <- modelFit1$analyses[[3]]$residuals
EST$resid4 <- modelFit1$analyses[[4]]$residuals
EST$resid5 <- modelFit1$analyses[[5]]$residuals

EST <- EST %>%
  rowwise %>%
  mutate(resid = mean(c(resid1,resid2,resid3,resid4,resid5)))

#calculate mean residual, as well as mean of original concentrations 
EST_mean <- EST %>% ungroup() %>%
  mutate(x="x") %>%
  group_by(SID) %>%
  summarise(residMean = mean(resid),
            Mean = mean(concentration,na.rm=T)) %>%
  left_join(.,EST_ranef)

#plot mean vs. residMean vs. raneff - SEEMS LIKE EITHER RESID OR RANEFF ARE GOOD OPTIONS - ALL CORS ABOVE 0.98 (resid slightly lower cor with mean, than ranef and mean)
pairs(~residMean+Mean+raneff,data=EST_mean, 
   main="Simple Scatterplot Matrix")
```
