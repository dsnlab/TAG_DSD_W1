---
title: "cleaning Saliva hormones"
author: "Nandi"
date: "9 May 2018"
output: html_document
---

#step1: import "final" mean concentrations, edit "????" based on raw concentrations (i.e. too low or too high for assay). and also based on other samples provided by the participant.

#step2: examine all repeats (re-runs) and make decision on whether to use original mean or repeat mean. edit "final" mean concentrations accordingly.

```{r, include=FALSE}
#LOAD PACKAGES AND SET DIRECTORIES

packages <- c("Amelia", "lme4" , "merTools", "ggplot2","tidyr","stringr","knitr","corrplot","data.table","readxl","gridExtra","dplyr", "psych","kableExtra","lavaan","xlsx","jomo","mice","Hmisc")
if (length(setdiff(packages, rownames(installed.packages()))) > 0) {
  install.packages(setdiff(packages, rownames(installed.packages())))  
}
lapply(packages, library, character.only = TRUE)

options(digits=10)

cas_dir <- '/Volumes/psych-cog/dsnlab/TAG/'
saliva_dir <- paste0(cas_dir,'behavior/Saliva/Wave1')
```

###IMPORT TAG OVERVIEW DOC FROM CAS
```{r, include = F}
overview <- read.xlsx(paste0(cas_dir,'behavior/Overview/Overview_Withdrawn_Completed/TAG_Overview_Doc.xlsx'),1)
overview <- overview[,c("TAG_ID","W1S2_Completed","Withdrawn_W1","Exclusionary_Withdrawl")]

#removing everyone who withdrew at W1 (exclusionary withdrawals & Withdrawn_W1)
overview <- overview %>% 
  rename(SID = TAG_ID) %>%
  replace_na(list(Withdrawn_W1 = 0)) %>%
  replace_na(list(Exclusionary_Withdrawl = 0)) %>% 
  arrange(Exclusionary_Withdrawl) %>% 
  mutate(SID=gsub("[^0-9\\.]", "", SID)) %>%
  filter(Exclusionary_Withdrawl==0) %>%
  filter(Withdrawn_W1==0)
```

###IMPORT "FINAL" SALIVA CONCENTRATIONS & IDENTIFY '?????'
```{r, echo=FALSE, message=FALSE, warning=FALSE, results="asis", fig.height=4, fig.width=4}
###IMPORT FINAL CONCENTRATIONS 
#version 1
Sal_DHEA_final1 <- read_xlsx(paste0(saliva_dir,'/TAG_SALIVA_Master_File.xlsx'), sheet=4)
Sal_TEST_final1 <- read_xlsx(paste0(saliva_dir,'/TAG_SALIVA_Master_File.xlsx'), sheet=8)
Sal_EST_final1 <- read_xlsx(paste0(saliva_dir,'/TAG_SALIVA_Master_File.xlsx'), sheet=12)

#version 2
Sal_DHEA_final2 <- read_xlsx(paste0(saliva_dir,'/TAG_MasterSheet_Saliva_2ndRun.xlsx'), sheet=6)
Sal_TEST_final2 <- read_xlsx(paste0(saliva_dir,'/TAG_MasterSheet_Saliva_2ndRun.xlsx'), sheet=4)
Sal_EST_final2 <- read_xlsx(paste0(saliva_dir,'/TAG_MasterSheet_Saliva_2ndRun.xlsx'), sheet=2)

#check entries with '?????' listed in concentration columns -
#these refer to either entries that are too high or too low.
DHEA_check1 <- filter(Sal_DHEA_final1, grepl('\\?',Concentration)) %>% rename(Mean=Concentration)
DHEA_check2 <- filter(Sal_DHEA_final2, grepl('\\?',Mean))
DHEA_check <- rbind(DHEA_check1,DHEA_check2)

TEST_check1 <- filter(Sal_TEST_final1, grepl('\\?',Concentration)) %>% rename(Mean=Concentration)
TEST_check2 <- filter(Sal_TEST_final2, grepl('\\?',Mean)) 
TEST_check <- rbind(TEST_check1,TEST_check2)

EST_check1 <- filter(Sal_EST_final1, grepl('\\?',Concentration)) %>% rename(Mean=Concentration)
EST_check2 <- filter(Sal_EST_final2, grepl('\\?',Mean)) 
EST_check <- rbind(EST_check1,EST_check2)


###NOTE: NV & MB to make decisions about how to update/use each of these '?????' values.


#format imported DFs for each hormone, update with deciscreate SID as 3 digit numeric factor (i.e. "001"), combine all three hormones in one dataframe. 
Sal_DHEA_final1 <- Sal_DHEA_final1 %>% 
  mutate(SID = as.factor(round(as.numeric(ID),2))) %>%
  mutate(sal_DHEA = ifelse(Concentration == "?????",1,Concentration)) %>%
  #mutate(sal_DHEA = 
  #         ifelse(SID == XXX,1,
  #         ifelse(SID == XXX,1,
  #         ifelse(SID == XXX,1,
  #         ifelse(SID == XXX,1, Concentration))))) %>%
  mutate(sal_DHEA = round(as.numeric(sal_DHEA),3)) %>%
  select(SID,sal_DHEA) %>%
  #replace_na(list(sal_DHEA = "missing")) %>%
  filter(!is.na(SID)) %>%
  separate(SID, into =c("SID","week")) %>%
  mutate(SID = str_pad(SID, 3, pad = "0")) %>%
  mutate(SID = as.factor(SID),
         week = as.factor(week))

Sal_DHEA_final2 <- Sal_DHEA_final2 %>% 
  mutate(SID = as.factor(round(as.numeric(ID),2))) %>%
  mutate(sal_DHEA = ifelse(Mean == "?????",1,Mean)) %>%
  #mutate(sal_DHEA = 
  #         ifelse(SID == XXX,1,
  #         ifelse(SID == XXX,1,
  #         ifelse(SID == XXX,1,
  #         ifelse(SID == XXX,1, Mean))))) %>%
  mutate(sal_DHEA = round(as.numeric(sal_DHEA),3)) %>%
  select(SID,sal_DHEA) %>%
  #replace_na(list(sal_DHEA = "missing")) %>%
  filter(!is.na(SID)) %>%
  separate(SID, into =c("SID","week")) %>%
  mutate(SID = str_pad(SID, 3, pad = "0")) %>%
  mutate(SID = as.factor(SID),
         week = as.factor(week))

Sal_TEST_final1 <- Sal_TEST_final1 %>% 
  mutate(SID = as.factor(round(as.numeric(ID),2))) %>%
  mutate(sal_TEST = ifelse(Concentration == "?????",1,Concentration)) %>%
  #mutate(sal_TEST =
  #         ifelse(SID == XXX,1,
  #         ifelse(SID == XXX,1,
  #         ifelse(SID == XXX,1,
  #         ifelse(SID == XXX,1, Concentration))))) %>%
  mutate(sal_TEST = round(as.numeric(sal_TEST),3)) %>%
  select(SID,sal_TEST) %>%
  replace_na(list(sal_TEST = "missing")) %>%
  filter(!is.na(SID)) %>%
  separate(SID, into =c("SID","week")) %>%
  mutate(SID = str_pad(SID, 3, pad = "0")) %>%
  mutate(SID = as.factor(SID),
         week = as.factor(week))

Sal_TEST_final2 <- Sal_TEST_final2 %>% 
  mutate(SID = as.factor(round(as.numeric(ID),2))) %>%
  mutate(sal_TEST = ifelse(Mean == "?????",1,Mean)) %>%
  #mutate(sal_TEST =
  #         ifelse(SID == XXX,1,
  #         ifelse(SID == XXX,1,
  #         ifelse(SID == XXX,1,
  #         ifelse(SID == XXX,1, Mean))))) %>%
  mutate(sal_TEST = round(as.numeric(sal_TEST),3)) %>%
  select(SID,sal_TEST) %>%
  replace_na(list(sal_TEST = "missing")) %>%
  filter(!is.na(SID)) %>%
  separate(SID, into =c("SID","week")) %>%
  mutate(SID = str_pad(SID, 3, pad = "0")) %>%
  mutate(SID = as.factor(SID),
         week = as.factor(week))

Sal_EST_final1 <- Sal_EST_final1 %>% 
  mutate(SID = as.factor(round(as.numeric(ID),2))) %>%
  mutate(sal_EST = ifelse(Concentration == "?????",1,Concentration)) %>%
  #mutate(sal_EST = 
  #         ifelse(SID == XXX,1,
  #         ifelse(SID == XXX,1,
  #         ifelse(SID == XXX,1,
  #         ifelse(SID == XXX,1, Concentration))))) %>%
  mutate(sal_EST = round(as.numeric(sal_EST),3)) %>%
  select(SID,sal_EST) %>%
  replace_na(list(sal_EST = "missing")) %>%
  filter(!is.na(SID)) %>%
  separate(SID, into =c("SID","week")) %>%
  mutate(SID = str_pad(SID, 3, pad = "0")) %>%
  mutate(SID = as.factor(SID),
         week = as.factor(week))

Sal_EST_final2 <- Sal_EST_final2 %>% 
  mutate(SID = as.factor(round(as.numeric(ID),2))) %>%
  mutate(sal_EST = ifelse(Mean == "?????",1,Mean)) %>%
  #mutate(sal_EST = 
  #         ifelse(SID == XXX,1,
  #         ifelse(SID == XXX,1,
  #         ifelse(SID == XXX,1,
  #         ifelse(SID == XXX,1, Mean))))) %>%
  mutate(sal_EST = round(as.numeric(sal_EST),3)) %>%
  select(SID,sal_EST) %>%
  replace_na(list(sal_EST = "missing")) %>%
  filter(!is.na(SID)) %>%
  separate(SID, into =c("SID","week")) %>%
  mutate(SID = str_pad(SID, 3, pad = "0")) %>%
  mutate(SID = as.factor(SID),
         week = as.factor(week))

Sal_DHEA_final <- rbind(Sal_DHEA_final1,Sal_DHEA_final2)
Sal_TEST_final <- rbind(Sal_TEST_final1,Sal_TEST_final2)
Sal_EST_final <- rbind(Sal_EST_final1,Sal_EST_final2)
```

###IMPORT SALIVA REPEATS
```{r, echo=FALSE, message=FALSE, warning=FALSE, results="asis", fig.height=4, fig.width=4}

#version1
Sal_DHEA_rep1 <- read_xlsx(paste0(saliva_dir,'/TAG_SALIVA_Master_File.xlsx'), sheet=3)
Sal_TEST_rep1 <- read_xlsx(paste0(saliva_dir,'/TAG_SALIVA_Master_File.xlsx'), sheet=7)
Sal_EST_rep1 <- read_xlsx(paste0(saliva_dir,'/TAG_SALIVA_Master_File.xlsx'), sheet=11)

#version2
Sal_DHEA_rep2 <- read_xlsx(paste0(saliva_dir,'/TAG_MasterSheet_Saliva_2ndRun.xlsx'), sheet=5)
Sal_TEST_rep2 <- read_xlsx(paste0(saliva_dir,'/TAG_MasterSheet_Saliva_2ndRun.xlsx'), sheet=3)
Sal_EST_rep2 <- read_xlsx(paste0(saliva_dir,'/TAG_MasterSheet_Saliva_2ndRun.xlsx'), sheet=1)

Sal_DHEA_rep1 <- Sal_DHEA_rep1 %>%
  rename(SID = Name,
         rep1 = TAG_2017.07.18_DHEA_Yoojin.xlsx,
         rep2 = X__1,
         CV2 = X__2,
         notes = X__3) %>%
  mutate(rep1 = as.numeric(rep1)) %>%
  filter(!is.na(rep1)) %>%
  mutate(SID = as.factor(round(as.numeric(SID),2))) %>%
  separate(SID, into =c("SID","week")) %>%
  mutate(SID = str_pad(SID, 3, pad = "0")) %>%
  mutate(SID = as.factor(SID),
         week = as.factor(week)) %>%
  filter(!(SID == "Name")) %>%
  filter(SID %in% overview$SID)

Sal_DHEA_rep2 <- Sal_DHEA_rep2 %>%
  rename(SID = Name,
         rep = X__5) %>%
  mutate(rep = as.numeric(rep)) %>%
  filter(!is.na(rep))

#Sal_DHEA_final <- Sal_DHEA_final %>% 
  #mutate(sal_DHEA = 
  #         ifelse(SID == XXX & week == X,1,
  #         ifelse(SID == XXX & week == X,1,
  #         ifelse(SID == XXX & week == X,1,
  #         ifelse(SID == XXX & week == X,1, sal_DHEA)))))
  
Sal_TEST_rep1 <- Sal_TEST_rep1 %>% 
  rename(SID = Name,
         rep1 = tag_06.18.2017_testo_tray2_ellen.xlsx,
         rep2 = X__1,
         CV2 = X__2,
         notes = X__3) %>%
  mutate(rep1 = as.numeric(rep1)) %>%
  filter(!is.na(rep1)) %>%
  mutate(SID = as.factor(round(as.numeric(SID),2))) %>%
  separate(SID, into =c("SID","week")) %>%
  mutate(SID = str_pad(SID, 3, pad = "0")) %>%
  mutate(SID = as.factor(SID),
         week = as.factor(week)) %>%
  filter(!(SID == "Name"))  %>%
  filter(SID %in% overview$SID)

#Sal_TEST_rep2 - none present

#Sal_TEST_final <- Sal_DHEA_final %>% 
  #mutate(sal_TEST = 
  #         ifelse(SID == XXX & week == X,1,
  #         ifelse(SID == XXX & week == X,1,
  #         ifelse(SID == XXX & week == X,1,
  #         ifelse(SID == XXX & week == X,1, sal_TEST)))))

Sal_EST_rep1 <- Sal_EST_rep1 %>% 
  rename(SID = Name,
         rep1 = TAG_06.18.2017_Estradiol_Tray2_Olivia.xlsx,
         rep2 = X__1,
         CV2 = X__2,
         notes = X__3) %>%
  mutate(rep1 = as.numeric(rep1)) %>%
  filter(!is.na(rep1)) %>%
  mutate(SID = as.factor(round(as.numeric(SID),2))) %>%
  separate(SID, into =c("SID","week")) %>%
  mutate(SID = str_pad(SID, 3, pad = "0")) %>%
  mutate(SID = as.factor(SID),
         week = as.factor(week)) %>%
  filter(!(SID == "Name"))  %>%
  filter(SID %in% overview$SID)

Sal_EST_rep2 <- Sal_EST_rep2 %>%
  rename(SID = Name,
         rep = X__5) %>%
  mutate(rep = as.numeric(rep)) %>%
  filter(!is.na(rep))

#Sal_EST_final <- Sal_DHEA_final %>% 
  #mutate(sal_EST = 
  #         ifelse(SID == XXX & week == X,1,
  #         ifelse(SID == XXX & week == X,1,
  #         ifelse(SID == XXX & week == X,1,
  #         ifelse(SID == XXX & week == X,1, sal_EST)))))
```

###FINAL MEAN CONCENTRATIONS & DISTRIBUTIONS
```{r, echo=FALSE, message=FALSE, warning=FALSE, results="asis", fig.height=7, fig.width=15}
Saliva <- Sal_DHEA_final %>% full_join(.,Sal_TEST_final) %>% full_join(.,Sal_EST_final) %>%
  mutate(ID = paste(SID,week,sep="_")) 
  #%>% filter(SID %in% overview$SID) #DO WE FILTER TO OUR FINAL SUBJECT LIST??
Saliva_long <- gather(Saliva, hormone, concentration, c(sal_DHEA,sal_TEST,sal_EST), factor_key=TRUE)
Saliva_long <- Saliva_long %>%
  mutate(concentration = as.numeric(concentration))

#plot concentrations
Saliva_plot <- Saliva_long %>% 
  ggplot(aes(x = concentration)) +
  geom_histogram(color="black",fill="white") +
  facet_wrap(~ hormone, scales="free")
Saliva_plot

###LOG TRANSFORMATION - NOTE FROM HERE ON, "CONCENTRATION" IS LOG TRANSFORMED###
Saliva_long <- Saliva_long %>% 
  mutate(concentration_orig = concentration,
         concentration = log(concentration + 4)) 

#plot transformed concentrations
Saliva_plot <- Saliva_long %>% 
  ggplot(aes(x = concentration)) +
  geom_histogram(color="black",fill="white") +
  facet_wrap(~ hormone, scales="free")
Saliva_plot
```

###IMPORT SALIVA CVs
```{r, echo=FALSE, message=FALSE, warning=FALSE, results="asis", fig.height=4, fig.width=4}
Sal_DHEA_CV <- read_xlsx(paste0(saliva_dir,'/TAG_SALIVA_Master_File.xlsx'), sheet=1)
Sal_TEST_CV <- read_xlsx(paste0(saliva_dir,'/TAG_SALIVA_Master_File.xlsx'), sheet=5)
Sal_EST_CV <- read_xlsx(paste0(saliva_dir,'/TAG_SALIVA_Master_File.xlsx'), sheet=9)

Sal_DHEA_CV <- Sal_DHEA_CV %>% 
  filter(!is.na(Name)) %>%
  select(Name,`CV (%)`, `CV (%)__1`) %>%
  rename(ID = Name,
         DHEA_CV = `CV (%)`,
         DHEA_450CV = `CV (%)__1`) %>%
  mutate(SID = as.factor(round(as.numeric(ID),2)),
         DHEA_CV = round(as.numeric(DHEA_CV),3),
         DHEA_450CV = round(as.numeric(DHEA_450CV),3)) %>%
  select(SID,DHEA_CV,DHEA_450CV) %>%
  separate(SID, into =c("SID","week")) %>%
  mutate(SID = str_pad(SID, 3, pad = "0")) %>%
  mutate(SID = as.factor(SID),
         week = as.factor(week)) %>%
  filter(!is.na(SID))

Sal_TEST_CV <- Sal_TEST_CV %>% 
  filter(!is.na(Name)) %>%
  select(Name,`CV (%)`, `CV (%)__1`) %>%
  rename(ID = Name,
         TEST_CV = `CV (%)`,
         TEST_450CV = `CV (%)__1`) %>%
  mutate(SID = as.factor(round(as.numeric(ID),2)),
         TEST_CV = round(as.numeric(TEST_CV),3),
         TEST_450CV = round(as.numeric(TEST_450CV),3)) %>%
  select(SID,TEST_CV,TEST_450CV) %>%
  separate(SID, into =c("SID","week")) %>%
  mutate(SID = str_pad(SID, 3, pad = "0")) %>%
  mutate(SID = as.factor(SID),
         week = as.factor(week)) %>%
  filter(!is.na(SID))

Sal_EST_CV <- Sal_EST_CV %>% 
  filter(!is.na(Name)) %>%
  select(Name,`CV (%)`, `CV (%)__1`) %>%
  rename(ID = Name,
         EST_CV = `CV (%)`,
         EST_450CV = `CV (%)__1`) %>%
  mutate(SID = as.factor(round(as.numeric(ID),2)),
         EST_CV = round(as.numeric(EST_CV),3),
         EST_450CV = round(as.numeric(EST_450CV),3)) %>%
  select(SID,EST_CV,EST_450CV) %>%
  separate(SID, into =c("SID","week")) %>%
  mutate(SID = str_pad(SID, 3, pad = "0")) %>%
  mutate(SID = as.factor(SID),
         week = as.factor(week)) %>%
  filter(!is.na(SID))

Saliva_CV <- Sal_DHEA_CV %>% full_join(.,Sal_TEST_CV) %>% full_join(.,Sal_EST_CV) %>%
  mutate(ID = paste(SID,week,sep="_")) %>%
  filter(SID %in% overview$SID)
```

###DISTRIBUTIONS OF CV
```{r, echo=FALSE, message=FALSE, warning=FALSE, results="asis", fig.height=7, fig.width=15}
CVplot <- Saliva_CV %>% select(SID, DHEA_CV, TEST_CV, EST_CV) %>%
  gather(-SID, key = "var", value = "value") %>% 
  ggplot(aes(x = value)) +
  geom_histogram(color="black",fill="white") +
  facet_wrap(~ var,scales="free")

CVplot

#if we want to see how many kids have CV > 30...
DHEA_CV_exc <- Saliva_CV %>% filter(DHEA_CV > 30) %>% select(ID)
TEST_CV_exc <- Saliva_CV %>% filter(TEST_CV > 30) %>% select(ID)
EST_CV_exc <- Saliva_CV %>% filter(EST_CV > 30) %>% select(ID)
```

```{r, include=FALSE}
###INDIVIDUAL CV PLOTS - DO NOT PRINT
DHEA_CV<-ggplot(Saliva_CV, aes(x=DHEA_CV)) +
  geom_histogram(color="black",fill="white")
# + geom_vline(xintercept=30,linetype="dashed",colour="red")
DHEA_CV

TEST_CV<-ggplot(Saliva_CV, aes(x=TEST_CV)) +
  geom_histogram(color="black",fill="white")
# + geom_vline(xintercept=30,linetype="dashed",colour="red")
TEST_CV

EST_CV<-ggplot(Saliva_CV, aes(x=EST_CV)) +
  geom_histogram(color="black",fill="white")
# + geom_vline(xintercept=30,linetype="dashed",colour="red")
EST_CV
```

###DISTRIBUTIONS OF 450 CV
```{r, echo=FALSE, message=FALSE, warning=FALSE, results="asis", fig.height=7, fig.width=15}

CV_450_plot <- Saliva_CV %>% select(SID, DHEA_450CV, TEST_450CV, EST_450CV) %>%
  gather(-SID, key = "var", value = "value") %>% 
  ggplot(aes(x = value)) +
  geom_histogram(color="black",fill="white") +
  facet_wrap(~ var,scales="free")

CV_450_plot

#if we want to see how many kids have CV > 30...
DHEA_450CV_exc <- Saliva_CV %>% filter(DHEA_450CV > 20) %>% select(ID)
TEST_450CV_exc <- Saliva_CV %>% filter(TEST_450CV > 20) %>% select(ID)
EST_450CV_exc <- Saliva_CV %>% filter(EST_450CV > 20) %>% select(ID)
```

###THE REST OF THE SCRIPT EXAMINES HOW TO BEST CONTROL FOR EXTRANEOUS FACTORS AND CREATE A MEAN (BASAL) SALIVA CONCENTRATION
#So far, the script controls for confound using two methods: 1. linear mixed models (LMM) and 2. linear regression. The latter does not appropriately account for repeated nature of measurements. Both these estimates are also compared to the mean concentration (without controlling for confounds).

###CREATE DF OF SALIVA CONC AND FORMS
```{r, echo=FALSE, message=FALSE, warning=FALSE, results="asis", fig.height=7, fig.width=15}

control_df <- read.csv(paste0(saliva_dir,'/W1_at_home_saliva_overview.csv'))
control_df <- control_df %>% 
  mutate(SID=gsub("[^0-9\\.]", "", subject_spit_id)) %>%
  mutate(SID = as.factor(SID)) %>%
  select(SID, s1_complete, s1_doc, s1_wake_up_time, s1_start_time, s1_time_to_collect, s1_medicines_y_n, s1_sick_y_n, s2_complete, s2_doc, s2_wake_up_time, s2_start_time, s2_time_to_collect, s2_medicines_y_n, s2_sick_y_n, s3_complete, s3_doc, s3_wake_up_time, s3_start_time, s3_time_to_collect, s3_medicines_y_n, s3_sick_y_n, s4_complete, s4_doc, s4_wake_up_time, s4_start_time, s4_time_to_collect, s4_medicines_y_n, s4_sick_y_n, s5_complete, s5_doc, s5_wake_up_time, s5_start_time, s5_time_to_collect, s5_medicines_y_n, s5_sick_y_n, s6_complete, s6_doc, s6_wake_up_time, s6_start_time, s6_time_to_collect, s6_medicines_y_n, s6_sick_y_n, s7_complete, s7_doc, s7_start_time, s7_time_to_collect, s7_medicines_y_n, s7_sick_y_n, s8_complete, s8_doc, s8_time_to_collect, s8_medicines_y_n, s8_sick_y_n) %>% ##need to add in s7_wake_up_time and s8_wake_up_time
  filter(!SID=="") 

control_long <- gather(control_df, weeks, measurement, -SID) %>%
  separate(weeks, c("week", "variable"), extra = "merge") %>%
  spread(variable,measurement) %>%
  mutate(week=gsub("[^0-9\\.]", "", week))

#combine Saliva and Control variables
Saliva_control_long <- Saliva_long %>% left_join(., control_long) 

#make blank cells NAs - missing forms:
Saliva_control_long <- apply(Saliva_control_long, 2, function(x) gsub("^$|^ $", NA, x))

#make variables into appropriate factors - R seems to import time variables (i.e. waking time and colleciton[aka start] time) with today's date. But this is fine, because all data has the same "date", which is removed when centering. In order to use time variables in imputation, I converted the them to numeric. This still maintains variability between participants, but is in a more usable format.

Saliva_control_long <- as.data.frame(Saliva_control_long) %>%
  mutate(sick_y_n = as.factor(sick_y_n),
         medicines_y_n = as.factor(medicines_y_n),
         start_time=as.POSIXct(start_time,format="%H:%M"),
         wake_up_time=as.POSIXct(wake_up_time,format="%H:%M"),
         concentration=as.numeric(as.character(concentration))) %>%
  mutate(time_diff = difftime(start_time,wake_up_time)/60) %>%
  mutate(time_diff = as.numeric(time_diff)) %>%
  mutate(start_time_num = as.numeric(start_time)) %>%
  mutate(wake_up_time_num = as.numeric(wake_up_time))
```

###CHECK EFFECTS OF CONFOUNDS USING LMER (LONG DATASET)
```{r}
###DHEA###
DHEA <- Saliva_control_long %>% filter(hormone=="sal_DHEA") %>%
  mutate(start_time_num = (start_time_num-mean(start_time_num,na.rm=T))/100,
         wake_up_time_num = (wake_up_time_num-mean(wake_up_time_num,na.rm=T))/100,
         time_diff = (time_diff-mean(time_diff,na.rm=T))/100)         

DHEA_lmm <- DHEA %>% filter(complete.cases(concentration,sick_y_n,medicines_y_n,wake_up_time_num,time_diff))
                                       
DHEA_null <- lmer(concentration ~ 1 + (1 | SID), data=DHEA_lmm, REML = F)
DHEA_time <- lmer(concentration ~ wake_up_time_num + time_diff + (1 | SID), data=DHEA_lmm, REML = F)
DHEA_sick_y_n <- lmer(concentration ~ sick_y_n + (1 | SID), data=DHEA_lmm, REML = F)
DHEA_medicines_y_n <- lmer(concentration ~ medicines_y_n + (1 | SID), data=DHEA_lmm, REML = F)
anova(DHEA_null,DHEA_time)
anova(DHEA_null,DHEA_sick_y_n)
anova(DHEA_null,DHEA_medicines_y_n)

###TEST###
TEST <- Saliva_control_long %>% filter(hormone=="sal_TEST") %>%
    mutate(start_time_num = (start_time_num-mean(start_time_num,na.rm=T))/100,
         wake_up_time_num = (wake_up_time_num-mean(wake_up_time_num,na.rm=T))/100,
         time_diff = (time_diff-mean(time_diff,na.rm=T))/100) 

TEST_lmm <- TEST %>% filter(complete.cases(concentration,sick_y_n,medicines_y_n,wake_up_time_num,time_diff))
                                       
TEST_null <- lmer(concentration ~ 1 + (1 | SID), data=TEST_lmm, REML = F)
TEST_time <- lmer(concentration ~ wake_up_time_num + time_diff + (1 | SID), data=TEST_lmm, REML = F)
TEST_sick_y_n <- lmer(concentration ~ sick_y_n + (1 | SID), data=TEST_lmm, REML = F)
TEST_medicines_y_n <- lmer(concentration ~ medicines_y_n + (1 | SID), data=TEST_lmm, REML = F)
anova(TEST_null,TEST_time) #trending
anova(TEST_null,TEST_sick_y_n)
anova(TEST_null,TEST_medicines_y_n)

###EST###
EST <- Saliva_control_long %>% filter(hormone=="sal_EST") %>%
    mutate(start_time_num = (start_time_num-mean(start_time_num,na.rm=T))/100,
         wake_up_time_num = (wake_up_time_num-mean(wake_up_time_num,na.rm=T))/100,
         time_diff = (time_diff-mean(time_diff,na.rm=T))/100)  

EST_lmm <- EST %>% filter(complete.cases(concentration,sick_y_n,medicines_y_n,wake_up_time_num,time_diff))
                                       
EST_null <- lmer(concentration ~ 1 + (1 | SID), data=EST_lmm, REML = F)
EST_time <- lmer(concentration ~ wake_up_time_num + time_diff + (1 | SID), data=EST_lmm, REML = F)
EST_sick_y_n <- lmer(concentration ~ sick_y_n + (1 | SID), data=EST_lmm, REML = F)
EST_medicines_y_n <- lmer(concentration ~ medicines_y_n + (1 | SID), data=EST_lmm, REML = F)
anova(EST_null,EST_time)
anova(EST_null,EST_sick_y_n)
anova(EST_null,EST_medicines_y_n) #sig
```

###CHECK EFFECTS OF CONFOUNDS USING LM (WIDE DATASET) - REDUNDANT STEP, BUT JUST CHECKING
```{r}
#checking effect of control variables using LM (same as above using LMER, but without accounting for ID grouping - so not ideal methodology, but just curious)

summary(lm(concentration ~ start_time_num, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_DHEA")))
summary(lm(concentration ~ start_time_num, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_TEST")))
summary(lm(concentration ~ start_time_num, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_EST"))) #sig effect

summary(lm(concentration ~ wake_up_time_num + time_diff, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_DHEA"))) #trending
summary(lm(concentration ~ wake_up_time_num + time_diff, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_TEST")))
summary(lm(concentration ~ wake_up_time_num + time_diff, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_EST")))

summary(lm(concentration ~ sick_y_n, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_DHEA")))
summary(lm(concentration ~ sick_y_n, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_TEST")))
summary(lm(concentration ~ sick_y_n, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_EST")))

summary(lm(concentration ~ medicines_y_n, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_DHEA")))
summary(lm(concentration ~ medicines_y_n, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_TEST")))
summary(lm(concentration ~ medicines_y_n, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_EST"))) #sig effect
                   
summary(lm(concentration ~ time_to_collect, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_DHEA")))
summary(lm(concentration ~ time_to_collect, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_TEST")))
summary(lm(concentration ~ time_to_collect, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_EST")))

#plot start_time distribution
Start_time <- Saliva_control_long %>% filter(hormone=="sal_EST") %>% select(SID,week,start_time) %>% arrange(start_time)
Start_time <- as.POSIXlt(Start_time$start_time)$hour
hist(Start_time, breaks=seq(0, 23), main="Start time (hour)")

###consistencies across LM and LMER = EST * medicines###
```

###CONTROL FOR CONFOUNDS USING LMER
```{r}
#Extraction of random effects from LMM, after multiple imputation with Amelia 

#Model controlling for confounds
fml <- "concentration ~ wake_up_time_num + medicines_y_n + time_diff + (1 | SID)"

###DHEA###
#imputation with Amelia
impDHEA <- DHEA %>% 
  select(SID,week,concentration,medicines_y_n,sick_y_n,wake_up_time_num,time_diff) %>%
  mutate(week=as.numeric(week))
aout <- amelia(impDHEA, idvars = "SID", 
            ords = c("medicines_y_n","sick_y_n"),
            ts="week",
            m = 10)
aout_list <- as.list(aout$imputations) 

#lmm of mulitply imputed datasets with merTools
DHEAmod <- lmerModList(fml, data = aout_list)
modelFixedEff(DHEAmod)

#extract random effect and coefficients (which add fixed effect to the random effect)
DHEA_eff <- lapply(X=DHEAmod, function(X) {
    ranef <- as.data.frame(ranef(X)) %>% select(grp,condval)
    coef <- as.data.frame(coef(X)$SID) %>% bind_cols(ranef)    
  })
DHEA_eff <- rbindlist(DHEA_eff) 
DHEA_eff <- DHEA_eff %>% group_by(grp) %>% 
  summarise(coef = mean(`(Intercept)`),
            ranef = mean(condval)) %>%
  mutate(SID=as.numeric(as.character(grp))) %>%
  arrange(SID)

###TEST###
#imputation with Amelia
impTEST <- TEST %>% 
  select(SID,week,concentration,medicines_y_n,sick_y_n,wake_up_time_num,time_diff) %>%
  mutate(week=as.numeric(week))

aout <- amelia(impTEST, idvars = "SID", 
            ords = c("medicines_y_n","sick_y_n"),
            ts="week",
            m = 5)
aout_list <- as.list(aout$imputations) 

#lmm of mulitply imputed datasets with merTools
TESTmod <- lmerModList(fml, data = aout_list)
modelFixedEff(TESTmod)

#extract random effect and coefficients (which add fixed effect to the random effect)
TEST_eff <- lapply(TESTmod, function(X) {
    ranef <- as.data.frame(ranef(X)) %>% select(grp,condval)
    coef <- as.data.frame(coef(X)$SID) %>% bind_cols(ranef)    
  })
TEST_eff <- rbindlist(TEST_eff) 
TEST_eff <- TEST_eff %>% group_by(grp) %>% 
  summarise(coef = mean(`(Intercept)`),
            ranef = mean(condval)) %>%
  mutate(SID=as.numeric(as.character(grp))) %>%
  arrange(SID)

###EST###
#imputation with Amelia
impEST <- EST %>% 
  select(SID,week,concentration,medicines_y_n,sick_y_n,wake_up_time_num,time_diff) %>%
  mutate(week=as.numeric(week))

aout <- amelia(impEST, idvars = "SID", 
            ords = c("medicines_y_n","sick_y_n"),
            ts="week",
            m = 5)
aout_list <- as.list(aout$imputations) 

#lmm of mulitply imputed datasets with merTools
ESTmod <- lmerModList(fml, data = aout_list)
modelFixedEff(ESTmod)

#extract random effect and coefficients (which add fixed effect to the random effect)
EST_eff <- lapply(ESTmod, function(X) {
    ranef <- as.data.frame(ranef(X)) %>% select(grp,condval)
    coef <- as.data.frame(coef(X)$SID) %>% bind_cols(ranef)    
  })
EST_eff <- rbindlist(EST_eff) 
EST_eff <- EST_eff %>% group_by(grp) %>% 
  summarise(coef = mean(`(Intercept)`),
            ranef = mean(condval)) %>%
  mutate(SID=as.numeric(as.character(grp))) %>%
  arrange(SID)
```

###CALCULATE RESIDUALS FOR CROSS-SEC DATAFRAME AND THEN AVERAGE THESE RESIDUALS
```{r}
#using MICE to impute and run pooled analyses

fml <- "concentration ~ wake_up_time_num + medicines_y_n + time_diff"

###DHEA###
impDHEA_mice <- mice(impDHEA,m=5,maxit=10,meth='pmm',seed=500)

modelFit1 <- with(impDHEA_mice,lm(as.formula(fml)))
summary(pool(modelFit1))

DHEA$resid1 <- modelFit1$analyses[[1]]$residuals
DHEA$resid2 <- modelFit1$analyses[[2]]$residuals
DHEA$resid3 <- modelFit1$analyses[[3]]$residuals
DHEA$resid4 <- modelFit1$analyses[[4]]$residuals
DHEA$resid5 <- modelFit1$analyses[[5]]$residuals

DHEA <- DHEA %>%
  rowwise %>%
  mutate(resid = mean(c(resid1,resid2,resid3,resid4,resid5)))

###TEST###
impTEST_mice <- mice(impTEST,m=5,maxit=10,meth='pmm',seed=500)

modelFit1 <- with(impTEST_mice,lm(as.formula(fml)))
summary(pool(modelFit1))

#extract residuals for each imputation
TEST$resid1 <- modelFit1$analyses[[1]]$residuals
TEST$resid2 <- modelFit1$analyses[[2]]$residuals
TEST$resid3 <- modelFit1$analyses[[3]]$residuals
TEST$resid4 <- modelFit1$analyses[[4]]$residuals
TEST$resid5 <- modelFit1$analyses[[5]]$residuals

TEST <- TEST %>%
  rowwise %>%
  mutate(resid = mean(c(resid1,resid2,resid3,resid4,resid5)))

###EST###
impEST_mice <- mice(impEST,m=5,maxit=10,meth='pmm',seed=500)

modelFit1 <- with(impEST_mice,lm(as.formula(fml)))
summary(pool(modelFit1))

#extract residuals for each imputation
EST$resid1 <- modelFit1$analyses[[1]]$residuals
EST$resid2 <- modelFit1$analyses[[2]]$residuals
EST$resid3 <- modelFit1$analyses[[3]]$residuals
EST$resid4 <- modelFit1$analyses[[4]]$residuals
EST$resid5 <- modelFit1$analyses[[5]]$residuals

EST <- EST %>%
  rowwise %>%
  mutate(resid = mean(c(resid1,resid2,resid3,resid4,resid5)))
```

###CORRELATE OUTPUT FROM LMER, LM
```{r}
#this step also calculates mean concentration across the weeks without controlling for confounds. this is correlated with the output from LMER and LM.

###DHEA###
DHEA_mean <- DHEA %>% ungroup() %>%
  mutate(x="x") %>%
  group_by(SID) %>%
  summarise(residMean = mean(resid),
            Mean = mean(concentration,na.rm=T)) %>%
  mutate(SID=as.numeric(as.character(SID))) %>%
  left_join(.,DHEA_eff)

#plot mean vs. residMean vs. raneff - SEEMS LIKE EITHER RESID OR RANEFF ARE GOOD OPTIONS - ALL CORS ABOVE 0.99
pairs(~residMean+Mean+coef,data=DHEA_mean, 
   main="Simple Scatterplot Matrix")

###TEST###
TEST_mean <- TEST %>% ungroup() %>%
  mutate(x="x") %>%
  group_by(SID) %>%
  summarise(residMean = mean(resid),
            Mean = mean(concentration,na.rm=T)) %>%
  mutate(SID=as.numeric(as.character(SID))) %>%
  left_join(.,TEST_eff)

#plot mean vs. residMean vs. raneff - SEEMS LIKE EITHER RESID OR RANEFF ARE GOOD OPTIONS - ALL CORS ABOVE 0.99
pairs(~residMean+Mean+coef,data=TEST_mean, 
   main="Simple Scatterplot Matrix") 

###EST###
EST_mean <- EST %>% ungroup() %>%
  mutate(x="x") %>%
  group_by(SID) %>%
  summarise(residMean = mean(resid),
            Mean = mean(concentration,na.rm=T)) %>%
  mutate(SID=as.numeric(as.character(SID))) %>%
  left_join(.,EST_eff)

#plot mean vs. residMean vs. raneff - SEEMS LIKE EITHER RESID OR RANEFF ARE GOOD OPTIONS - ALL CORS ABOVE 0.98 (resid slightly lower cor with mean, than ranef and mean)
pairs(~residMean+Mean+coef,data=EST_mean, 
   main="Simple Scatterplot Matrix")