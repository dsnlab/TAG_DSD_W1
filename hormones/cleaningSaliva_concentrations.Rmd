---
title: "cleaning Saliva hormones"
author: "Nandi"
date: "9 May 2018"
output: html_document
---

```{r, include=FALSE}
#LOAD PACKAGES AND SET DIRECTORIES

packages <- c("ggplot2","tidyr","stringr","knitr","corrplot","data.table","readxl","gridExtra","dplyr", "psych","kableExtra","lavaan","xlsx","jomo","mice","Hmisc")
if (length(setdiff(packages, rownames(installed.packages()))) > 0) {
  install.packages(setdiff(packages, rownames(installed.packages())))  
}
lapply(packages, library, character.only = TRUE)

cas_dir <- '/Volumes/psych-cog/dsnlab/TAG/'
saliva_dir <- paste0(cas_dir,'behavior/Saliva/Wave1')
options(digits=3)
```

###IMPORT TAG OVERVIEW DOC FROM CAS
```{r, include = F}
overview <- read.xlsx(paste0(cas_dir,'behavior/Overview/Overview_Withdrawn_Completed/TAG_Overview_Doc.xlsx'),1)
overview <- overview[,c("TAG_ID","W1S2_Completed","Withdrawn_W1","Exclusionary_Withdrawl")]

#removing everyone who withdrew at W1 (exclusionary withdrawals)
overview <- overview %>% 
  rename(SID = TAG_ID) %>%
  replace_na(list(Withdrawn_W1 = 0)) %>%
  replace_na(list(Exclusionary_Withdrawl = 0)) %>% 
  arrange(Exclusionary_Withdrawl) %>% 
  mutate(SID=gsub("[^0-9\\.]", "", SID)) %>%
  filter(Exclusionary_Withdrawl==0)
```

###IMPORT "FINAL" SALIVA CONCENTRATIONS
```{r, echo=FALSE, message=FALSE, warning=FALSE, results="asis", fig.height=4, fig.width=4}
###IMPORT & CLEAN CONCENTRATIONS 
#import dataframe for each hormone, create SID as 3 digit numeric factor (i.e. "001"), combine all three hormones in one dataframe. 
Sal_DHEA <- read_xlsx(paste0(saliva_dir,'/TAG_SALIVA_Master_File.xlsx'), sheet=4)
Sal_TEST <- read_xlsx(paste0(saliva_dir,'/TAG_SALIVA_Master_File.xlsx'), sheet=8)
Sal_EST <- read_xlsx(paste0(saliva_dir,'/TAG_SALIVA_Master_File.xlsx'), sheet=12)

Sal_DHEA <- Sal_DHEA %>% 
  mutate(Concentration = ifelse(Concentration =='?????',1,Concentration)) %>%
  mutate(SID = as.factor(round(as.numeric(ID),2)),
         sal_DHEA = round(as.numeric(Concentration),3)) %>%
  select(SID,sal_DHEA) %>%
  replace_na(list(sal_DHEA = "missing")) %>%
  filter(!is.na(SID)) %>%
  separate(SID, into =c("SID","week")) %>%
  mutate(SID = str_pad(SID, 3, pad = "0")) %>%
  mutate(SID = as.factor(SID),
         week = as.factor(week))

Sal_TEST <- Sal_TEST %>% 
  mutate(Concentration = ifelse(Concentration =='?????',4,Concentration)) %>%
  mutate(SID = as.factor(round(as.numeric(ID),2)),
         sal_TEST = round(as.numeric(Concentration),3)) %>%
  select(SID,sal_TEST) %>%
  replace_na(list(sal_TEST = "missing")) %>%
  filter(!is.na(SID)) %>%
  separate(SID, into =c("SID","week")) %>%
  mutate(SID = str_pad(SID, 3, pad = "0")) %>%
  mutate(SID = as.factor(SID),
         week = as.factor(week))

Sal_EST <- Sal_EST %>% 
  mutate(Concentration = ifelse(Concentration =='?????',0.1,Concentration)) %>%
  mutate(SID = as.factor(round(as.numeric(ID),2)),
         sal_EST = round(as.numeric(Concentration),3)) %>%
  select(SID,sal_EST) %>%
  replace_na(list(sal_EST = "missing")) %>%
  filter(!is.na(SID)) %>%
  separate(SID, into =c("SID","week")) %>%
  mutate(SID = str_pad(SID, 3, pad = "0")) %>%
  mutate(SID = as.factor(SID),
         week = as.factor(week))

Saliva <- Sal_DHEA %>% full_join(.,Sal_TEST) %>% full_join(.,Sal_EST) %>%
  mutate(ID = paste(SID,week,sep="_")) %>%
  filter(SID %in% overview$SID)
```

###IMPORT SALIVA CVs
```{r, echo=FALSE, message=FALSE, warning=FALSE, results="asis", fig.height=4, fig.width=4}
Sal_DHEA_CV <- read_xlsx(paste0(saliva_dir,'/TAG_SALIVA_Master_File.xlsx'), sheet=1)
Sal_TEST_CV <- read_xlsx(paste0(saliva_dir,'/TAG_SALIVA_Master_File.xlsx'), sheet=5)
Sal_EST_CV <- read_xlsx(paste0(saliva_dir,'/TAG_SALIVA_Master_File.xlsx'), sheet=9)

Sal_DHEA_CV <- Sal_DHEA_CV %>% 
  filter(!is.na(Name)) %>%
  select(Name,`CV (%)`, `CV (%)__1`) %>%
  rename(ID = Name,
         DHEA_CV = `CV (%)`,
         DHEA_450CV = `CV (%)__1`) %>%
  mutate(SID = as.factor(round(as.numeric(ID),2)),
         DHEA_CV = round(as.numeric(DHEA_CV),3),
         DHEA_450CV = round(as.numeric(DHEA_450CV),3)) %>%
  select(SID,DHEA_CV,DHEA_450CV) %>%
  separate(SID, into =c("SID","week")) %>%
  mutate(SID = str_pad(SID, 3, pad = "0")) %>%
  mutate(SID = as.factor(SID),
         week = as.factor(week)) %>%
  filter(!is.na(SID))

Sal_TEST_CV <- Sal_TEST_CV %>% 
  filter(!is.na(Name)) %>%
  select(Name,`CV (%)`, `CV (%)__1`) %>%
  rename(ID = Name,
         TEST_CV = `CV (%)`,
         TEST_450CV = `CV (%)__1`) %>%
  mutate(SID = as.factor(round(as.numeric(ID),2)),
         TEST_CV = round(as.numeric(TEST_CV),3),
         TEST_450CV = round(as.numeric(TEST_450CV),3)) %>%
  select(SID,TEST_CV,TEST_450CV) %>%
  separate(SID, into =c("SID","week")) %>%
  mutate(SID = str_pad(SID, 3, pad = "0")) %>%
  mutate(SID = as.factor(SID),
         week = as.factor(week)) %>%
  filter(!is.na(SID))

Sal_EST_CV <- Sal_EST_CV %>% 
  filter(!is.na(Name)) %>%
  select(Name,`CV (%)`, `CV (%)__1`) %>%
  rename(ID = Name,
         EST_CV = `CV (%)`,
         EST_450CV = `CV (%)__1`) %>%
  mutate(SID = as.factor(round(as.numeric(ID),2)),
         EST_CV = round(as.numeric(EST_CV),3),
         EST_450CV = round(as.numeric(EST_450CV),3)) %>%
  select(SID,EST_CV,EST_450CV) %>%
  separate(SID, into =c("SID","week")) %>%
  mutate(SID = str_pad(SID, 3, pad = "0")) %>%
  mutate(SID = as.factor(SID),
         week = as.factor(week)) %>%
  filter(!is.na(SID))

Saliva_CV <- Sal_DHEA_CV %>% full_join(.,Sal_TEST_CV) %>% full_join(.,Sal_EST_CV) %>%
  mutate(ID = paste(SID,week,sep="_")) %>%
  filter(SID %in% overview$SID)
```

###IMPORT SALIVA REPLICATES
```{r, echo=FALSE, message=FALSE, warning=FALSE, results="asis", fig.height=4, fig.width=4}

Sal_DHEA_CV_rep <- read_xlsx(paste0(saliva_dir,'/TAG_SALIVA_Master_File.xlsx'), sheet=3)
Sal_TEST_CV_rep <- read_xlsx(paste0(saliva_dir,'/TAG_SALIVA_Master_File.xlsx'), sheet=7)
Sal_EST_CV_rep <- read_xlsx(paste0(saliva_dir,'/TAG_SALIVA_Master_File.xlsx'), sheet=11)

Sal_DHEA_CV_rep <- Sal_DHEA_CV_rep %>%
  rename(SID = Name,
         rep1 = TAG_2017.07.18_DHEA_Yoojin.xlsx,
         rep2 = X__1,
         CV2 = X__2,
         notes = X__3) %>%
  mutate(rep1 = as.numeric(rep1)) %>%
  filter(!is.na(rep1)) %>%
  mutate(SID = as.factor(round(as.numeric(SID),2))) %>%
  separate(SID, into =c("SID","week")) %>%
  mutate(SID = str_pad(SID, 3, pad = "0")) %>%
  mutate(SID = as.factor(SID),
         week = as.factor(week)) %>%
  filter(!(SID == "Name")) %>%
  filter(SID %in% overview$SID)

Sal_TEST_CV_rep <- Sal_TEST_CV_rep %>% 
  rename(SID = Name,
         rep1 = tag_06.18.2017_testo_tray2_ellen.xlsx,
         rep2 = X__1,
         CV2 = X__2,
         notes = X__3) %>%
  mutate(rep1 = as.numeric(rep1)) %>%
  filter(!is.na(rep1)) %>%
  mutate(SID = as.factor(round(as.numeric(SID),2))) %>%
  separate(SID, into =c("SID","week")) %>%
  mutate(SID = str_pad(SID, 3, pad = "0")) %>%
  mutate(SID = as.factor(SID),
         week = as.factor(week)) %>%
  filter(!(SID == "Name"))  %>%
  filter(SID %in% overview$SID)

Sal_EST_CV_rep <- Sal_EST_CV_rep %>% 
  rename(SID = Name,
         rep1 = TAG_06.18.2017_Estradiol_Tray2_Olivia.xlsx,
         rep2 = X__1,
         CV2 = X__2,
         notes = X__3) %>%
  mutate(rep1 = as.numeric(rep1)) %>%
  filter(!is.na(rep1)) %>%
  mutate(SID = as.factor(round(as.numeric(SID),2))) %>%
  separate(SID, into =c("SID","week")) %>%
  mutate(SID = str_pad(SID, 3, pad = "0")) %>%
  mutate(SID = as.factor(SID),
         week = as.factor(week)) %>%
  filter(!(SID == "Name"))  %>%
  filter(SID %in% overview$SID)
```

###DISTRIBUTIONS OF CONCENTRATIONS
```{r, echo=FALSE, message=FALSE, warning=FALSE, results="asis", fig.height=7, fig.width=15}
Saliva_long <- gather(Saliva, hormone, concentration, c(sal_DHEA,sal_TEST,sal_EST), factor_key=TRUE)

#Saliva_long <- Saliva_long %>% 
#  mutate(missing = if_else(concentration == "missing",1,0))

Saliva_long <- Saliva_long %>%
  mutate(concentration = as.numeric(concentration))

Saliva_plot <- Saliva_long %>% 
  ggplot(aes(x = concentration)) +
  geom_histogram(color="black",fill="white") +
  facet_wrap(~ hormone, scales="free")

Saliva_plot

#hist(subset(Saliva_long, hormone == "sal_DHEA")$concentration, main="", xlab="DHEA")
#abline(v=600,col="red")
#writeLines("\n")
#hist(subset(Saliva_long, hormone == "sal_TEST")$concentration, main="", xlab="TEST")
#abline(v=200,col="red")
#writeLines("\n")
#hist(subset(Saliva_long, hormone == "sal_EST")$concentration, main="", xlab="EST")
#abline(v=3,col="red")
#writeLines("\n")
```

###DISTRIBUTIONS OF ICV
```{r, echo=FALSE, message=FALSE, warning=FALSE, results="asis", fig.height=7, fig.width=15}
CVplot <- Saliva_CV %>% select(SID, DHEA_CV, TEST_CV, EST_CV) %>%
  gather(-SID, key = "var", value = "value") %>% 
  ggplot(aes(x = value)) +
  geom_histogram(color="black",fill="white") +
  facet_wrap(~ var,scales="free")

CVplot

#if we want to see how many kids have CV > 30...
DHEA_CV_exc <- Saliva_CV %>% filter(DHEA_CV > 30) %>% select(ID)
TEST_CV_exc <- Saliva_CV %>% filter(TEST_CV > 30) %>% select(ID)
EST_CV_exc <- Saliva_CV %>% filter(EST_CV > 30) %>% select(ID)
```

```{r, include=FALSE}
###INDIVIDUAL ICV PLOTS - DO NOT PRINT
DHEA_CV<-ggplot(Saliva_CV, aes(x=DHEA_CV)) +
  geom_histogram(color="black",fill="white")
# + geom_vline(xintercept=30,linetype="dashed",colour="red")
DHEA_CV

TEST_CV<-ggplot(Saliva_CV, aes(x=TEST_CV)) +
  geom_histogram(color="black",fill="white")
# + geom_vline(xintercept=30,linetype="dashed",colour="red")
TEST_CV

EST_CV<-ggplot(Saliva_CV, aes(x=EST_CV)) +
  geom_histogram(color="black",fill="white")
# + geom_vline(xintercept=30,linetype="dashed",colour="red")
EST_CV
```

###DISTRIBUTIONS OF 450 ICV
```{r, echo=FALSE, message=FALSE, warning=FALSE, results="asis", fig.height=7, fig.width=15}

CV_450_plot <- Saliva_CV %>% select(SID, DHEA_450CV, TEST_450CV, EST_450CV) %>%
  gather(-SID, key = "var", value = "value") %>% 
  ggplot(aes(x = value)) +
  geom_histogram(color="black",fill="white") +
  facet_wrap(~ var,scales="free")

CV_450_plot

#if we want to see how many kids have CV > 30...
DHEA_450CV_exc <- Saliva_CV %>% filter(DHEA_450CV > 20) %>% select(ID)
TEST_450CV_exc <- Saliva_CV %>% filter(TEST_450CV > 20) %>% select(ID)
EST_450CV_exc <- Saliva_CV %>% filter(EST_450CV > 20) %>% select(ID)
```

###CHECK ASSOCIATIONS WITH CONTROL VARIABLES
```{r, echo=FALSE, message=FALSE, warning=FALSE, results="asis", fig.height=7, fig.width=15}

control_df <- read.csv(paste0(saliva_dir,'/W1_at_home_saliva_overview.csv'))
control_df <- control_df %>% 
  mutate(SID=gsub("[^0-9\\.]", "", subject_spit_id)) %>%
  mutate(SID = as.factor(SID)) %>%
  select(SID, s1_complete, s1_doc, s1_wake_up_time, s1_start_time, s1_time_to_collect, s1_medicines_y_n, s1_sick_y_n, s2_complete, s2_doc, s2_wake_up_time, s2_start_time, s2_time_to_collect, s2_medicines_y_n, s2_sick_y_n, s3_complete, s3_doc, s3_wake_up_time, s3_start_time, s3_time_to_collect, s3_medicines_y_n, s3_sick_y_n, s4_complete, s4_doc, s4_wake_up_time, s4_start_time, s4_time_to_collect, s4_medicines_y_n, s4_sick_y_n, s5_complete, s5_doc, s5_wake_up_time, s5_start_time, s5_time_to_collect, s5_medicines_y_n, s5_sick_y_n, s6_complete, s6_doc, s6_wake_up_time, s6_start_time, s6_time_to_collect, s6_medicines_y_n, s6_sick_y_n, s7_complete, s7_doc, s7_start_time, s7_time_to_collect, s7_medicines_y_n, s7_sick_y_n, s8_complete, s8_doc, s8_time_to_collect, s8_medicines_y_n, s8_sick_y_n) %>% ##need to add in s7_wake_up_time and s8_wake_up_time
  filter(!SID=="") 

control_long <- gather(control_df, weeks, measurement, -SID) %>%
  separate(weeks, c("week", "variable"), extra = "merge") %>%
  spread(variable,measurement) %>%
  mutate(week=gsub("[^0-9\\.]", "", week))

Saliva_control_long <- Saliva_long %>% left_join(., control_long) %>%
  mutate(sick_y_n = as.factor(sick_y_n),
         medicines_y_n = as.factor(medicines_y_n),
         start_time=as.POSIXct(start_time,format="%H:%M"),
         wake_up_time=as.POSIXct(wake_up_time,format="%H:%M"),
         time_to_collect=as.numeric(time_to_collect))

summary(lm(concentration ~ start_time, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_DHEA")))
summary(lm(concentration ~ start_time, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_TEST")))
summary(lm(concentration ~ start_time, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_EST")))

summary(lm(concentration ~ wake_up_time, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_DHEA")))
summary(lm(concentration ~ wake_up_time, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_TEST")))
summary(lm(concentration ~ wake_up_time, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_EST")))

summary(lm(concentration ~ sick_y_n, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_DHEA")))
summary(lm(concentration ~ sick_y_n, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_TEST")))
summary(lm(concentration ~ sick_y_n, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_EST")))

summary(lm(concentration ~ medicines_y_n, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_DHEA")))
summary(lm(concentration ~ medicines_y_n, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_TEST")))
summary(lm(concentration ~ medicines_y_n, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_EST")))
                   
summary(lm(concentration ~ time_to_collect, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_DHEA")))
summary(lm(concentration ~ time_to_collect, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_TEST")))
summary(lm(concentration ~ time_to_collect, data = subset(Saliva_control_long,Saliva_control_long$hormone=="sal_EST")))

#plot start_time distribution
Start_time <- Saliva_control_long %>% filter(hormone=="sal_EST") %>% select(SID,week,start_time) %>% arrange(start_time)
Start_time <- as.POSIXlt(Start_time$start_time)$hour
hist(Start_time, breaks=seq(0, 23), main="Start time (hour)")
```

###CALCULATE RESIDUALS
```{r}
DHEA <- Saliva_control_long %>% filter(hormone=="sal_DHEA") %>% 
  mutate(SID=as.factor(SID)) %>%
  select(SID,week,concentration,medicines_y_n,sick_y_n,time_to_collect,start_time,wake_up_time) %>%
  mutate(timediff = difftime(start_time,wake_up_time)/60) %>%
  mutate(timediff = as.numeric(timediff)) %>%
  mutate(wake_up_time = as.numeric(wake_up_time)) %>%
  select(-start_time)

#try Hmisc
impute_arg <- aregImpute(~ wake_up_time + timediff + medicines_y_n + sick_y_n, data = DHEA, n.impute = 5)

#try MICE
DHEA2 <- DHEA %>% 
  mutate(sick_y_n = ifelse(sick_y_n == 0, 0,
                           ifelse(sick_y_n ==1,1, NA)),
         medicines_y_n = ifelse(medicines_y_n == 0, 0,
                                ifelse(medicines_y_n ==1,1, NA)))
DHEA2$hour = as.POSIXlt(DHEA2$wake_up_time)$hour
DHEA2 <- DHEA2 %>% select(-start_time,-wake_up_time)

impDHEA <- mice(DHEA2,m=5,maxit=50,meth='pmm',seed=500)

modelFit1 <- with(impDHEA,lm(concentration~ medicines_y_n+sick_y_n+time_to_collect))
summary(pool(modelFit1))

DHEA$resid1 <- modelFit1$analyses[[1]]$residuals
DHEA$resid2 <- modelFit1$analyses[[2]]$residuals
DHEA$resid3 <- modelFit1$analyses[[3]]$residuals
DHEA$resid4 <- modelFit1$analyses[[4]]$residuals
DHEA$resid5 <- modelFit1$analyses[[5]]$residuals

DHEA <- DHEA %>%
  rowwise %>%
  mutate(resid = mean(c(resid1,resid2,resid3,resid4,resid5)))

DHEA_mean <- DHEA %>% ungroup() %>%
  mutate(x="x") %>%
  group_by(SID) %>%
  summarise(residMean = mean(resid),
            Mean = mean(concentration,na.rm=T))

#if we end up using MLM:
DHEAcontrols <- lme(concentration ~ start_time + medicines_y_n, random = ~1|SID, data = DHEA,na.action=na.exclude)
                    age + Sex, data = Orthodont, random = ~ 1)