---
title: "extractMotion"
author: "Nandi"
date: "28 March 2018"
output: html_document
---

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

###LOAD PACKAGES AND SET DIRECTORIES
```{r, include=FALSE}
packages <- c("dplyr","tidyr","data.table")
if (length(setdiff(packages, rownames(installed.packages()))) > 0) {
  install.packages(setdiff(packages, rownames(installed.packages())))  
}
lapply(packages, library, character.only = TRUE)

#Set CAS folder
cas_dir <- '/Volumes/psych-cog/dsnlab/TAG/'

#Set Wave
wave=1

setwd(cas_dir)
```

###IMPORT MRI OVERVIEW DOC FROM CAS
```{r, include = F}
MRIoverview <- read.csv(paste0(cas_dir,'behavior/MRI/Wave1/MRI_W',wave,'overview.csv'),header=T)

#List of everyone who has completed fmriprep according to overview document
###To be updated once MRI overview document is completed
MRIoverview <- MRIoverview %>% filter(!check_mri_completed.2.partial.1.full.0.none.==0) %>% select(SID,svc1_num,svc2_num,dsd1_num,dsd2_num)
```

###IMPORT FMRIPREP MOTION CONFOUNDS AND WRITE RAW PARAMS (X,Y,Z,pitch,roll,yaw)
```{r, include=FALSE}
motionFiles = list.files(path=paste0(cas_dir,'bids_data/derivatives/fmriprep/'),pattern='bold_confounds.tsv', recursive = TRUE, full.names=T)

motion <- lapply(X=motionFiles, FUN=function(file) {
  SID <- sub(".*sub-TAG", "", file) %>% substring(., 1,3)
  task <- sub(".*task-", "", file) %>% substring(., 1,3)
  run <- sub(".*run-0", "", file) %>% substring(., 1,1)  
  motionData <- read.table(file, sep = '\t', header=T)
  motionData <- motionData %>% select(X,Y,Z,RotX,RotY,RotZ)
    
    #mutate(FramewiseDisplacement=as.character(FramewiseDisplacement)) %>%
    #mutate(FramewiseDisplacement=replace(FramewiseDisplacement, FramewiseDisplacement=='n/a', 0)) %>%
    #mutate(FramewiseDisplacement = as.numeric(FramewiseDisplacement)) 
    
  write.table(motionData, file=paste0(cas_dir,'nonbids_data/fmri/fx/motion/wave',wave,'/rawmotion/TAG',SID,'_',task,run,'.txt'), sep='\t', row.name=F, quote=F, col.names=F)
  
  out <- as.data.frame(cbind(SID,task,run))
  })
```

###CHECK THAT ALL SUBKECTS HAVE MOTION DATA 
```{r, include=FALSE}
motion <- rbindlist(motion)
motion <- motion %>% mutate(task = paste0(task, "_", run)) %>%
  select(-run) %>%
  group_by(SID,task) %>%
  summarize(n=n()) %>%
  spread(key=task,value=n) %>%
  ungroup() %>%
  mutate(SID = as.numeric(as.character(SID)))

#check that all subjects have motion data
MRIoverview2 <- MRIoverview %>% full_join(.,motion) %>% 
  mutate(svc1_missing = ifelse(!svc1_num == 0 & is.na(SVC_1), 1, 0),
         svc2_missing = ifelse(!svc2_num == 0 & is.na(SVC_2), 1, 0),
         dsd1_missing = ifelse(!dsd1_num == 0 & is.na(DSD_1), 1, 0),
         dsd2_missing = ifelse(!dsd2_num == 0 & is.na(DSD_2), 1, 0))
         #TAG028 seems to be missing SVC1 motion file
```
