---
title: "createMulticonds"
author: "Nandi"
date: "15 June 2018"
output: html_document
---

#This script reads behavioral output from DSD (from script 'TAG_scripts/behavior/dsd/cleanDSD_behavior.Rmd'). Formats the data and saves subject-specific files that are subsequently used in Matlab script ('2_generateMulticonds.m').

#The format of modelling is: 2 statement (affect, neutral) and 4 disclosure (affect vs neutral, share vs private) conditions, with share.value as a pmod.

#Events: affect statement=1, neutral statement=2, affect_share==3, neutral_share=4, affect_private==5, neutral_private==6

#Multicond file type
#1: all, 2: no missing, 3: no neut_pri, 4: no neut_pri & missing, 5: no aff_pri
#6: no aff_pri & missing, 7: no aff_pri & neut_pri, 8: no aff_pri & neut_pri & missing
#9: no neut_share, 10: no aff_share

#Load packages and set directories
```{r, include=FALSE}
packages <- c("nlme", "ggplot2", "tidyr", "stringr", "knitr","corrplot","data.table", "readxl", "gridExtra", "dplyr", "psych","kableExtra","lavaan",    "stringi")
if (length(setdiff(packages, rownames(installed.packages()))) > 0) {
  install.packages(setdiff(packages, rownames(installed.packages())))  
}
lapply(packages, library, character.only = TRUE)

# read input file from
input_file <- '/Volumes/psych-cog/dsnlab/TAG/behavior/task/processed/dsd_trials_long.csv'

# directory to save output. make sure folder is created.
out_dir <- '/Volumes/psych-cog/dsnlab/TAG/nonbids_data/fmri/fx/multiconds/dsd/wave1/Summary/'
```

#Read data
```{r}
input_df <- read.csv(input_file)
input_df <- input_df %>% filter(wave==1)
ids <- as.vector(unique(input_df$sid))
```

#Format multiconds and save output
```{r}
multicondsDF <- lapply(X=ids, df=input_df, FUN=function(id, df) {
  
df <- df %>% filter(sid==id)
  
if(nrow(df %>% filter(run==1)) > 0 & nrow(df %>% filter(run==2)) > 0) {
  
  df <- df %>% mutate(statement.condition = ifelse(affective == TRUE, 1,
                                                     ifelse(affective == FALSE, 2, NA)),
                        disc.condition = ifelse(affective == TRUE & disclosed == TRUE, 1,
                                                ifelse(affective == FALSE & disclosed == TRUE, 2,
                                                       ifelse(affective == TRUE & disclosed == FALSE, 3,
                                                              ifelse(affective == FALSE & disclosed == FALSE, 4, NA))))) %>%
      select(sid,run,trial,statement.condition,statement.onset,disc.condition,disc.onset,share.value)

  df_long <- df %>% 
      gather(v, value, statement.condition:disc.onset) %>% 
      separate(v, c("task", "v2")) %>% 
      arrange(sid) %>% 
      spread(v2, value) %>%
      arrange(run,trial,desc(task)) %>%
      mutate(name = ifelse(task == "disc" & condition == 1, 3,
                           ifelse(task == "disc" & condition == 2, 4,
                                  ifelse(task == "disc" & condition == 3, 5,
                                         ifelse(task == "disc" & condition == 4, 6, condition))))) %>%
      mutate(name = ifelse(is.na(name), 7, name)) %>%
      group_by(run) %>%
      mutate(duration = lead(onset) - onset) %>%
      mutate(pmod = ifelse(task=="statement",NA,share.value)) %>%
      mutate(pmod = ifelse(pmod < 0, -1,
                           ifelse(pmod > 0, 1,
                                  ifelse(pmod == 0, 0, NA)))) %>%
      select(sid,run,name,onset,duration,pmod) %>%
      mutate(duration = ifelse(is.na(duration),3,duration))

    fid = stri_pad_left(id, 3, 0)

    multicondDF <- df_long %>% filter(name %in% c(3,4,5,6,7)) %>%
      mutate(name=(paste0('cond_',name)),
             name=factor(name, levels=c('cond_3','cond_4','cond_5','cond_6','cond_7'))) %>%
      group_by(run,name) %>% summarise(N = n()) %>%
      complete(name, fill = list(N = 0)) %>% spread(key=name,value=N) %>%
      mutate(multicond = ifelse((cond_3>0 & cond_4>0 & cond_5>0 & cond_6>0 & cond_7>0),1,
                         ifelse((cond_3>0 & cond_4>0 & cond_5>0 & cond_6>0 & cond_7==0),2,
                         ifelse((cond_3>0 & cond_4>0 & cond_5>0 & cond_6==0 & cond_7>0),3,
                         ifelse((cond_3>0 & cond_4>0 & cond_5>0 & cond_6==0 & cond_7==0),4,
                         ifelse((cond_3>0 & cond_4>0 & cond_5==0 & cond_6>0 & cond_7>0),5,
                         ifelse((cond_3>0 & cond_4>0 & cond_5==0 & cond_6>0 & cond_7==0),6,
                         ifelse((cond_3>0 & cond_4>0 & cond_5==0 & cond_6==0 & cond_7>0),7,       
                         ifelse((cond_3>0 & cond_4>0 & cond_5==0 & cond_6==0 & cond_7==0),8,
                         ifelse((cond_3>0 & cond_4==0 & cond_5>0 & cond_6>0 & cond_7>0),9,
                         ifelse((cond_3==0 & cond_4>0 & cond_5>0 & cond_6>0 & cond_7>0),10,
                         ifelse((cond_3==0 & cond_4==0 & cond_5==0 & cond_6==0 & cond_7>0),11,  #only 174, run 2 (not part of final sample)
                                NA))))))))))),
             sid=id) %>% select(-contains("cond_"))
  
    df_long <- df_long %>% left_join(.,multicondDF)
    
    saveDF <- df_long %>% group_by(run) %>%
      do({
        ungroup(.) 
        write.csv(.,file=paste0(out_dir,'tag_',fid,'_DSD',.$run[[1]],'summary.csv'),row.names=F,na = "",)
        data.frame()
        })

    df_long

} else {
  
    sid=id
    run1 <- nrow(df %>% filter(run==1))
    run2 <- nrow(df %>% filter(run==2))
    check <- cbind(sid, run1, run2)
    check <- as.data.table(check) }
})
```

#Check IDs with errors
```{r}
multicondsDF <- rbindlist(multicondsDF, fill=T)

#full subject list: 165 subjects
all_ids <- unique(multicondsDF$sid)

#IDs to check and run manually: 9 subjects
check_ids <- multicondsDF %>% select(sid,run1,run2) %>% filter(!is.na(run1))

#completed subjects - processed completely: 156 subjects
comp_DF <- multicondsDF %>% select(sid,run,name,onset,duration,pmod,multicond) %>%
  filter(!sid %in% check_ids$sid)
comp_IDS <- unique(comp_DF$sid) 
```

#Create a document outlining what conditions each subject has
```{r}
summary_byRun <- comp_DF %>% group_by(sid,run,name) %>% summarise(N = n()) %>% filter(name %in% c(3,4,5,6,7)) %>% group_by(run,name) %>% summarise(N = n()) 

summary_DF <- comp_DF %>% filter(name %in% c(3,4,5,6,7)) %>%
  mutate(name=as.factor(paste0('cond_',name))) %>%
  group_by(sid,run,name) %>% summarise(N = n()) %>%
  complete(name, fill = list(N = 0)) %>% spread(key=name,value=N)
write.csv(summary_DF, '~/Desktop/dsd_summary_bySubj.csv',row.names=F)

summary_bySubj <- comp_DF %>% group_by(sid,run) %>% summarise(multicond=mean(multicond))                           

write.csv(summary_bySubj, '~/Desktop/dsd_summary_bySubj.csv',row.names=F)
```

#Of the completed list, how many had useable fMRI data - i.e. what is my final dataset.
```{r}
#import dsd overview doc
dsd_overview <- read.csv('~/Desktop/dsd_overview.csv',header=T)
dsd_overview <- dsd_overview %>% 
  mutate(multiconds = ifelse(SID %in% comp_IDS, 1, 0))

#final DSD fMRI list
final_list <- dsd_overview %>% #189
  filter(Withdrawn_W1==0) %>% #174
  filter(!check_mri_completed.2.partial.1.full.0.none.==0) %>% #164
  filter(dsd_completed == 2) %>% #151
  filter(is.na(technical_missing)) %>% #148
  filter(is.na(participant_error)) %>% #146 
  filter(multiconds==1) 

#save final list
dsd_overview <- dsd_overview %>% 
  mutate(final_sample = ifelse(SID %in% final_list$SID, 1, 0))
write.csv(dsd_overview, '~/Desktop/dsd_overview.csv',row.names=F)
```

#Of the final list, check how many subjects differ in multiconds between run 1 and run 2 - for creating contrasts.
```{r}
con_bySubj <- summary_bySubj %>% filter(sid %in% final_list$SID) %>% arrange(sid,run) %>% group_by(sid) %>%
  mutate(sameCon = ifelse(multicond==lead(multicond),1,0)) %>%
  filter(run==1) %>%
  filter(sameCon==0) %>%
  arrange(multicond)
write.csv(con_bySubj, '~/Desktop/con_bySubj.csv',row.names=F)
