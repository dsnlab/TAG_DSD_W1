---
title: "extractMotion"
author: "Nandi"
date: "28 March 2018"
output: html_document
---

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

###LOAD PACKAGES AND SET DIRECTORIES
```{r, include=FALSE}
packages <- c("dplyr","tidyr","data.table")
if (length(setdiff(packages, rownames(installed.packages()))) > 0) {
  install.packages(setdiff(packages, rownames(installed.packages())))  
}
lapply(packages, library, character.only = TRUE)

#Set CAS folder
cas_dir <- '/Volumes/psych-cog/dsnlab/TAG/'

#Set Wave
wave=1
```

###IMPORT MRI OVERVIEW DOC FROM CAS
```{r, include = F}
MRIoverview <- read.csv(paste0(cas_dir,'behavior/MRI/Wave1/MRI_W',wave,'overview.csv'),header=T)
MRIoverview <- MRIoverview %>% 
  rename(SID = TAG_ID) %>%
  mutate(SID=as.factor(gsub("[^0-9\\.]", "", SID)))

#List of everyone who has completed fmriprep according to overview document
###To be updated once MRI onverview document is completed
MRIoverview <- MRIoverview %>% filter(fmriprep==1) %>% select(SID)
```

###IMPORT FMRIPREP MOTION CONFOUNDS
```{r, include=FALSE}
setwd(paste0(cas_dir,'bids_data/derivatives/fmriprep/'))
motionFiles = list.files(path='bids_data/derivatives/fmriprep/',pattern='bold_confounds.tsv', recursive = TRUE, full.names=T)

motion <- lapply(X=motionFiles, FUN=function(file) {
  SID <- sub(".*sub-TAG", "", file) %>% substring(., 1,3)
  task <- sub(".*task-", "", file) %>% substring(., 1,3)
  run <- sub(".*run-0", "", file) %>% substring(., 1,1)  
  motionData <- read.table(file, sep = '\t', header=T)
  motionData <- motionData %>% select(X,Y,Z,RotX,RotY,RotZ,FramewiseDisplacement,contains('aCompCor')) %>%
    mutate(FramewiseDisplacement=as.character(FramewiseDisplacement)) %>%
    mutate(FramewiseDisplacement=replace(FramewiseDisplacement, FramewiseDisplacement=='n/a', 0)) %>%
    mutate(FramewiseDisplacement = as.numeric(FramewiseDisplacement)) 
    
  write.table(motionData, file=paste0(cas_dir,'nonbids_data/fmri/fx/motion/wave',wave,'/motion_',SID,'_',task,run,'.txt'), sep='\t', row.name=F, quote=F, col.names=F)
  
  out <- as.data.frame(cbind(SID,task,run))
  })
```

###CREATE OVERVIEW DOC COMPARING MOTION OUTPUT AND EXPECTED FMRI OUTPUT
```{r, include=FALSE}
motion <- rbindlist(motion)
motion <- motion %>% mutate(task = paste0(task, "_", run)) %>%
  select(-run) %>%
  group_by(SID,task) %>%
  summarize(n=n()) %>%
  spread(key=task,value=n)

#check that all subjects have motion data
MRIoverview <- MRIoverview %>% full_join(.,motion)
```
